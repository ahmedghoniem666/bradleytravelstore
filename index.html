<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bradley Travelstore - Compare & Save on Hotels and Flights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #1e40af;
            --accent: #b45309;
            --light: #f1f5f9;
            --dark: #334155;
            --success: #059669;
            --danger: #dc2626;
            --warning: #b45309;
            --border-radius: 8px;
            --box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            --hotel-color: #dbeafe;
            --flight-color: #fef3c7;
            --supplier-color: #f1f5f9;
            --bg: #e0f2fe;
            --text: #475569;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --muted-text: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            position: relative;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: transparent;
        }
        
        .stars::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(0.5px 0.5px at 10px 20px, rgba(59, 130, 246,0.4), transparent),
                radial-gradient(0.5px 0.5px at 30px 50px, rgba(59, 130, 246,0.3), transparent),
                radial-gradient(0.5px 0.5px at 50px 10px, rgba(59, 130, 246,0.35), transparent),
                radial-gradient(0.5px 0.5px at 70px 60px, rgba(59, 130, 246,0.2), transparent),
                radial-gradient(0.5px 0.5px at 90px 30px, rgba(59, 130, 246,0.45), transparent);
            background-repeat: repeat;
            background-size: 100px 100px;
            animation: sparkle 4s ease-in-out infinite alternate;
            opacity: 0.6;
        }
        
        @keyframes sparkle {
            from { opacity: 0.4; }
            to { opacity: 0.8; }
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 16px 0;
            box-shadow: var(--box-shadow);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            font-size: 1.8rem;
        }
        
        .logo-text {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-like-btn {
            background: transparent;
            color: white;
            padding: 8px 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .section-like-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .reset-btn {
            background: var(--danger);
        }
        
        .reset-btn:hover {
            background: #dc2626 !important;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 24px;
            color: var(--primary);
            position: relative;
            font-size: 1.6rem;
            font-weight: 600;
        }
        
        .section-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background: var(--primary);
            margin: 8px auto;
            border-radius: 2px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .hotel-card {
            background-color: var(--hotel-color);
            border-left: 4px solid var(--primary);
        }
        
        .flight-card {
            background-color: var(--flight-color);
            border-left: 4px solid var(--accent);
        }
        
        .supplier-section {
            background-color: var(--supplier-color);
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        
        .supplier-best-price {
            background-color: #ecfdf5 !important;
            border: 2px solid var(--success);
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            background: var(--card-bg);
            color: var(--text);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .cancellation-fee-group {
            display: none;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 0.8rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        th, td {
            padding: 4px 6px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            min-width: 60px;
        }
        
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background-color: rgba(248, 250, 252, 0.5);
        }
        
        tr:hover {
            background-color: rgba(30, 58, 138, 0.05);
        }
        
        .best-price {
            background-color: #d1fae5 !important;
            border: 2px solid #059669 !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 24px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            min-height: 40px;
            font-size: 0.95rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            background: #92400e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background: var(--secondary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .btn-secondary:hover {
            background: #1e3a8a;
        }
        
        .btn-danger {
            background: var(--danger);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: var(--success);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .conversion-box {
            background: #eff6ff;
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        
        .email-template {
            background: var(--light);
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin: 16px 0;
            white-space: pre-line;
            line-height: 1.6;
            min-height: 200px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            color: var(--text);
            font-size: 0.95rem;
        }
        
        .delivery-options {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }
        
        .delivery-option {
            flex: 1;
            text-align: center;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            background: var(--card-bg);
            color: var(--text);
        }
        
        .delivery-option:hover {
            border-color: var(--secondary);
            box-shadow: var(--box-shadow);
        }
        
        .delivery-option[data-option="email"]:hover {
            border-color: #6c757d;
        }
        
        .delivery-option[data-option="whatsapp"]:hover {
            border-color: #25D366;
        }
        
        .delivery-option[data-option="messenger"]:hover {
            border-color: #0084ff;
        }
        
        .delivery-option.selected {
            border-color: var(--secondary);
            background: #eff6ff;
            box-shadow: 0 1px 2px rgba(30, 64, 175, 0.15);
        }
        
        .delivery-option.selected[data-option="email"] {
            border-color: #6c757d;
            background: #f8f9fa;
            box-shadow: 0 1px 2px rgba(108, 117, 125, 0.15);
        }
        
        .delivery-option.selected[data-option="whatsapp"] {
            border-color: #25D366;
            background: #e8f5e8;
            box-shadow: 0 1px 2px rgba(37, 211, 102, 0.15);
        }
        
        .delivery-option.selected[data-option="messenger"] {
            border-color: #0084ff;
            background: #e3f2fd;
            box-shadow: 0 1px 2px rgba(0, 132, 255, 0.15);
        }
        
        .delivery-option i {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .delivery-option[data-option="email"] i {
            color: #6c757d;
        }
        
        .delivery-option[data-option="whatsapp"] i {
            color: #25D366;
        }
        
        .delivery-option[data-option="messenger"] i {
            color: #0084ff;
        }
        
        .delivery-option.selected[data-option="email"] i {
            color: #6c757d;
        }
        
        .delivery-option.selected[data-option="whatsapp"] i {
            color: #25D366;
        }
        
        .delivery-option.selected[data-option="messenger"] i {
            color: #0084ff;
        }
        
        footer {
            background: var(--dark);
            color: white;
            padding: 32px 0 16px;
            margin-top: 64px;
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            gap: 32px;
            flex-wrap: wrap;
        }
        
        .footer-section {
            flex: 1;
            min-width: 200px;
        }
        
        .footer-section h3 {
            margin-bottom: 16px;
            color: var(--accent);
            font-weight: 600;
        }
        
        .footer-section ul {
            list-style: none;
        }
        
        .footer-section ul li {
            margin-bottom: 6px;
        }
        
        .footer-section a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-section a:hover {
            color: white;
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 24px;
            margin-top: 24px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }
        
        .rooms-selector {
            margin-bottom: 16px;
        }
        .rooms-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.room-type {
    flex: 1;
    min-width: 0; /* Allows shrinking if needed */
                border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 12px;
            background: var(--light);
            font-size: 0.85rem;
}

        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .room-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.95rem;
        }
        
        .room-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.7rem;
        }
        
        .people-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .people-type {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            min-width: 80px;
            font-size: 0.8rem;
        }
        
        .people-type h3 {
            margin-bottom: 6px;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .counter {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }
        
        .counter-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .counter-btn:hover {
            background: #1e3a8a;
        }
        
        .counter-value {
            font-size: 1rem;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
            color: var(--primary);
        }
        
        .converter-result {
            background: var(--success);
            color: white;
            padding: 12px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-top: 12px;
            font-weight: 600;
            display: none;
        }
        
        .child-ages-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
            justify-content: center;
        }
        
        .child-age-input {
            width: 70px;
            padding: 6px;
            font-size: 0.85rem;
            border-radius: var(--border-radius);
        }
        
        .upgrade-option {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .upgrade-option input {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .commission-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            font-size: 0.9rem;
            color: var(--muted-text);
        }
        
        .commission-percentage {
            font-weight: 600;
            color: var(--primary);
        }
        
        .hotel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .grand-total {
            background: var(--primary);
            color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-top: 16px;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .section-toggle {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.3s ease;
            padding: 6px 0;
        }
        
        .section-toggle:hover {
            color: var(--secondary);
        }
        
     .section-toggle i {
    transition: transform 0.3s ease;
    font-size: 1.1rem;
    color: var(--muted-text);
}

.collapsed .section-toggle i {
    transform: rotate(0deg) !important;
}

.expanded .section-toggle i {
    transform: rotate(180deg) !important;
}

        
.section-content {
    overflow: hidden;
    transition: max-height 0.3s ease-out, height 0.3s ease-out, margin-top 0.3s ease-out;
    margin-top: 12px;
}

.collapsed .section-content {
    max-height: 0 !important;
    margin-top: 0;
}

.expanded .section-content {
    max-height: none;
}
        
        .expanded .section-content {
            max-height: 3000px;
        }
        

        
        .age-label {
            font-size: 0.75rem;
            margin-top: 4px;
            color: var(--muted-text);
            text-align: center;
        }
        
        .booking-type-selector {
            margin-bottom: 16px;
        }
        
        .output-format-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .totals-panel {
            background: #eff6ff;
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        
        .totals-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .totals-label {
            font-weight: 600;
            color: var(--text);
        }
        
        .totals-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        .totals-row.grand-total {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 8px 0;
            border: 2px solid white;
            font-size: 1.15rem;
        }
        
        .totals-row.grand-total .totals-label,
        .totals-row.grand-total .totals-value {
            color: white;
            font-weight: 700;
        }
        
        .airport-display {
            font-size: 0.8rem;
            color: var(--muted-text);
            margin-top: 4px;
            font-style: italic;
        }
        
        .customer-info-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        
        .comparison-container {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .comparison-section {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 16px;
            border: 1px solid var(--border);
        }
        
        .comparison-section h3 {
            margin-bottom: 12px;
            color: var(--primary);
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .supplier-comparison {
            overflow-x: auto;
        }
        
        .supplier-comparison table th,
        .supplier-comparison table td {
            padding: 4px 6px;
            border: 1px solid var(--border);
            vertical-align: top;
            white-space: nowrap;
        }
        
        .supplier-comparison table .form-control {
            width: auto;
            min-width: 50px;
            max-width: 100px;
            padding: 3px 5px;
            font-size: 0.75rem;
        }
        
        .supplier-comparison table .form-control.supplier-name,
        .supplier-comparison table .form-control.supplier-hotel-name,
        .supplier-comparison table .form-control.room-type,
        .supplier-comparison table .form-control.upgrade-desc {
            min-width: 70px;
            max-width: 120px;
        }

        /* Adjustments for net price field */
        .supplier-comparison table .net-price,
        .flight-leg-row .net-price {
            min-width: 85px !important;
            max-width: 85px !important;
            font-size: 0.8rem !important;
        }

        /* Adjustments for upgrade cell to ensure visibility and scrolling */
        .upgrade-cell {
            min-width: 80px !important;
            width: 80px !important;
            max-width: 80px !important;
            white-space: normal !important;
            vertical-align: top !important;
            transition: width 0.3s ease, min-width 0.3s ease;
        }

        .upgrade-cell .form-control {
            min-width: 100px !important;
            max-width: none !important;
        }

        .upgrade-modes label {
            display: block !important;
            margin-bottom: 4px !important;
            font-size: 0.75rem !important;
            white-space: normal !important;
        }

        /* Expanded upgrade cell when checkbox is checked */
        .upgrade-cell:has(input[type="checkbox"]:checked) {
            min-width: 220px !important;
            width: 220px !important;
            max-width: 220px !important;
        }

        /* Ensure flight table upgrade cell expands similarly and fits words */
        .flight-legs-comparison .upgrade-cell {
            min-width: 80px !important;
            width: 80px !important;
            max-width: 80px !important;
        }

        .flight-legs-comparison .upgrade-cell:has(input[type="checkbox"]:checked) {
            min-width: 220px !important;
            width: 220px !important;
            max-width: 220px !important;
        }

        .flight-legs-comparison .upgrade-cell .upgrade-desc {
            min-width: 150px !important;
            white-space: normal !important;
        }
        
        .supplier-table-row.saved {
            background-color: #f0fdf4;
            border: 2px solid var(--success);
        }
        
        .supplier-table-row.best-price {
            background-color: #d1fae5 !important;
            border: 3px solid #059669 !important;
        }
        
        .supplier-summary-row {
            background: var(--light);
        }
        
        .optional-extras-section {
            margin-top: 16px;
            padding: 16px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .optional-extra-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .optional-extra-item input[type="text"] {
            flex: 2;
            min-width: 200px;
        }
        
        .optional-extra-item input[type="number"] {
            flex: 1;
            width: auto;
            min-width: 80px;
        }
        
        .optional-extra-item input[type="checkbox"] {
            flex: 0;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .price-per-room-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-label {
            display: block;
            margin-top: 4px;
            font-size: 0.75rem;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 4px;
        }

        .hotel-quote-section {
            margin-bottom: 16px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
        }

        .hotel-quote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .hotel-quote-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        .hotel-quote-section .section-toggle i {
    transition: transform 0.3s ease !important;
    font-size: 1.1rem !important;
    color: var(--muted-text) !important;
    transform: none !important;
}

.hotel-quote-section.collapsed .section-toggle i {
    transform: rotate(0deg) !important;
}

.hotel-quote-section.expanded .section-toggle i {
    transform: rotate(180deg) !important;
}

        .hotel-option-name {
            margin-bottom: 8px;
        }

        .upgrade-modes label {
            display: block;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        
        #custom-agent-name {
            margin-top: 6px;
        }

        .room-comparison {
            margin-bottom: 16px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
        }

        .room-comparison h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 24px;
            }
            
            nav ul {
                gap: 6px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .people-selector {
                flex-direction: column;
            }
            
            .child-ages-container {
                justify-content: center;
            }
            
            .hotel-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .upgrade-option {
                flex-direction: column;
            }
            
            .output-format-buttons {
                flex-direction: column;
            }
            
            .comparison-container {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn, .counter-btn {
                font-size: 0.95rem;
                padding: 10px 16px;
            }
            
            .logo-text {
                font-size: 1.2rem;
            }
            
            .counter-btn {
                width: 40px;
                height: 40px;
            }
            
            .counter-value {
                font-size: 1.4rem;
            }
            
            .delivery-options {
                flex-direction: column;
            }
            
            .delivery-option {
                min-width: auto;
            }
            
            .supplier-comparison table {
                font-size: 0.75rem;
            }
            
            .supplier-comparison table th,
            .supplier-comparison table td {
                padding: 3px 4px;
            }
            
            .supplier-comparison table .form-control {
                min-width: 35px;
                max-width: 70px;
                padding: 2px 3px;
                font-size: 0.7rem;
            }

            /* Mobile-specific adjustments for net price and upgrade */
            .supplier-comparison table .net-price,
            .flight-leg-row .net-price {
                min-width: 75px !important;
                max-width: 75px !important;
                font-size: 0.75rem !important;
            }

            .upgrade-cell {
                min-width: 60px !important;
                width: 60px !important;
                max-width: 60px !important;
            }

            .upgrade-cell:has(input[type="checkbox"]:checked) {
                min-width: 180px !important;
                width: 180px !important;
                max-width: 180px !important;
            }

            .upgrade-cell .form-control {
                min-width: 80px !important;
            }
            
            .optional-extra-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .room-type {
                padding: 10px;
            }

            .people-selector {
                flex-direction: column;
                gap: 6px;
            }

            .room-comparison {
                padding: 8px;
            }

            .rooms-row {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }
            
            .section-title {
                font-size: 1.4rem;
            }

            /* Extra small screen adjustments */
            .supplier-comparison table .net-price,
            .flight-leg-row .net-price {
                min-width: 70px !important;
                max-width: 70px !important;
            }

            .upgrade-cell {
                min-width: 50px !important;
                width: 50px !important;
            }

            .upgrade-cell:has(input[type="checkbox"]:checked) {
                min-width: 160px !important;
                width: 160px !important;
            }
        }

        .trip-type-selector {
            margin-bottom: 12px;
        }

        .trip-type-selector .form-group {
            display: inline-block;
            width: auto;
            margin-right: 12px;
        }

        .baggage-group {
            display: none;
        }

        .baggage-group.show {
            display: block;
        }

        .flight-number-input {
            min-width: 80px;
        }

        /* New CSS for flight legs horizontal scrolling */
        .flight-legs-comparison {
            overflow-x: auto;
        }

        .flight-legs-comparison table th,
        .flight-legs-comparison table td {
            padding: 4px 6px;
            border: 1px solid var(--border);
            vertical-align: top;
            white-space: nowrap;
        }

        .flight-legs-comparison table .form-control {
            width: auto;
            min-width: 50px;
            max-width: 100px;
            padding: 3px 5px;
            font-size: 0.75rem;
        }

        /* Mobile adjustments for flight table */
        @media (max-width: 768px) {
            .flight-legs-comparison table {
                font-size: 0.75rem;
            }

            .flight-legs-comparison table th,
            .flight-legs-comparison table td {
                padding: 3px 4px;
            }

            .flight-legs-comparison table .form-control {
                min-width: 35px;
                max-width: 70px;
                padding: 2px 3px;
                font-size: 0.7rem;
            }

            .flight-leg-row .net-price {
                min-width: 75px !important;
                max-width: 75px !important;
                font-size: 0.75rem !important;
            }

            .flight-legs-comparison .upgrade-cell {
                min-width: 60px !important;
                width: 60px !important;
                max-width: 60px !important;
            }

            .flight-legs-comparison .upgrade-cell:has(input[type="checkbox"]:checked) {
                min-width: 180px !important;
                width: 180px !important;
                max-width: 180px !important;
            }

            .flight-legs-comparison .upgrade-cell .form-control {
                min-width: 80px !important;
            }
        }

        @media (max-width: 480px) {
            .flight-leg-row .net-price {
                min-width: 70px !important;
                max-width: 70px !important;
            }

            .flight-legs-comparison .upgrade-cell {
                min-width: 50px !important;
                width: 50px !important;
            }

            .flight-legs-comparison .upgrade-cell:has(input[type="checkbox"]:checked) {
                min-width: 160px !important;
                width: 160px !important;
            }
        }

        .totals-subsection {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .totals-subsection h4 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        #commission-interpretation {
            display: none;
        }
    </style>
</head>
<body>
    <script src="data.js"></script>
    <div class="stars"></div>
    <header>
        <div class="container header-content">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-globe-americas"></i></div>
                <div class="logo-text">Bradley Travelstore</div>
            </div>
            <div class="header-controls">
                <nav>
                    <ul>
                        <li><a href="#customer">Customer Info</a></li>
                        <li><a href="#hotel">Hotel Quote</a></li>
                        <li><a href="#flight">Flight Quote</a></li>
                        <li><a href="#totals">Totals</a></li>
                        <li><a href="#email">Email Generator</a></li>
                    </ul>
                </nav>
                <button class="section-like-btn reset-btn" onclick="resetState()">Reset State</button>
            </div>
        </div>
    </header>

    <div class="container">
        <section id="customer" class="card customer-info-section expanded">
            <div class="section-toggle" onclick="toggleSection('customer')">
                <h2 class="section-title">Customer Information</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="section-content">
                <div class="booking-type-selector">
                    <div class="form-group">
                        <label for="booking-type">Booking Type</label>
                        <select id="booking-type" class="form-control" onchange="toggleSectionsBasedOnBookingType(); saveState();">
                            <option value="hotel">Hotel Only</option>
                            <option value="package">Package (Flight + Hotel)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name">Customer Name *</label>
                        <input type="text" id="customer-name" class="form-control" placeholder="Customer name" onchange="validateCustomerInfo(); updateEmailTemplate(); saveState();">
                    </div>
                    <div class="form-group">
                        <label for="quote-reference">Quote Reference #</label>
                        <input type="text" id="quote-reference" class="form-control" placeholder="Enter quote reference number" onchange="updateEmailTemplate(); saveState();">
                    </div>
                </div>

                <div class="rooms-selector">
                    <div class="people-type" style="justify-content: center;">
                        <h3>Rooms</h3>
                        <div class="counter">
                            <button class="counter-btn" onclick="changeRoomCount(-1)">-</button>
                            <span id="rooms-count" class="counter-value">1</span>
                            <button class="counter-btn" onclick="changeRoomCount(1)">+</button>
                        </div>
                    </div>
                    <div id="rooms-container">
                        <!-- Dynamic room details added here -->
                    </div>
                </div>
            </div>
        </section>

        <section id="hotel" class="card expanded">
            <div class="section-toggle" onclick="toggleSection('hotel')">
                <h2 class="section-title">Hotel Quote Details</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="section-content">
                <div id="hotel-quotes-container">
                    <!-- Hotel quote sections will be added here -->
                </div>
                <div class="comparison-controls">
                    <button class="btn" onclick="addHotelQuoteSection()"><i class="fas fa-plus"></i> Add Hotel Quote</button>
                </div>
            </div>
        </section>

        <section id="flight" class="card expanded">
            <div class="section-toggle" onclick="toggleSection('flight')">
                <h2 class="section-title">Flight Quote Details</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="flight-dates">Departure & Return Dates</label>
                        <input type="text" id="flight-dates" class="form-control" placeholder="Select dates">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="include-hand-baggage" checked onchange="updateEmailTemplate(); saveState();"> Include Hand Baggage
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="price-per-route" onchange="updateTotals(); updateEmailTemplate(); saveState();"> Price per Route (Departure and Return)
                    </label>
                </div>

                <h3>Flight Quotes</h3>
                <div id="flight-quotes-container">
                    <!-- Flight quote sections will be added here -->
                </div>
                <div class="comparison-controls">
                    <button class="btn" onclick="addFlightQuoteSection()"><i class="fas fa-plus"></i> Add Flight Quote</button>
                </div>
            </div>
        </section>

        <section id="optional-extras" class="card" style="display: none;">
            <div class="section-toggle" onclick="toggleSection('optional-extras')">
                <h2 class="section-title">Optional Extras</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="section-content">
                <div id="optional-extras-list">
                    <!-- Dynamic extras added here -->
                </div>
                <button class="btn btn-sm" onclick="addOptionalExtra()"><i class="fas fa-plus"></i> Add Optional Extra</button>
            </div>
        </section>

        <section id="totals" class="card expanded">
            <div class="section-toggle" onclick="toggleSection('totals')">
                <h2 class="section-title">Totals</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="section-content">
                <div class="form-group">
                    <label for="commission-rate">Commission Rate</label>
                    <input type="text" id="commission-rate" class="form-control" placeholder="Enter commission (e.g., 0.89 or 11%)" value="11%" onchange="updateCommission(); saveState();">
                    <div class="commission-display">
                        <span id="commission-display-text">11% (multiplier 1.11)</span>
                    </div>
                    <div id="commission-interpretation" class="commission-interpretation">
                        Interpreted rate: 11% (0.11)
                    </div>
                </div>
                
                <div class="totals-panel" id="totals-breakdown">
                    <!-- Dynamic totals breakdown will be inserted here -->
                </div>
            </div>
        </section>

        <section id="email" class="card expanded">
            <div class="section-toggle" onclick="toggleSection('email')">
                <h2 class="section-title">Email Generator</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="section-content">
                
                <div class="delivery-options">
                    <div class="delivery-option selected" data-option="email" onclick="selectDeliveryOption(this, 'email')">
                        <i class="fas fa-envelope"></i>
                        <p>Email</p>
                    </div>
                    <div class="delivery-option" data-option="whatsapp" onclick="selectDeliveryOption(this, 'whatsapp')">
                        <i class="fab fa-whatsapp"></i>
                        <p>WhatsApp</p>
                    </div>
                    <div class="delivery-option" data-option="messenger" onclick="selectDeliveryOption(this, 'messenger')">
                        <i class="fab fa-facebook-messenger"></i>
                        <p>Messenger</p>
                    </div>
                </div>
                
                <div class="price-per-room-group" id="price-per-room-group" style="display: block;">
                    <label>
                        <input type="checkbox" id="price-per-room" onchange="updateEmailTemplate(); saveState();"> Price per Room
                    </label>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="agent-name">Agent Name</label>
                        <select id="agent-name" class="form-control" onchange="updateAgentSignature(); saveState();">
                            <option value="Adam">Adam</option>
                            <option value="Alicia">Alicia</option>
                            <option value="Andy">Andy</option>
                            <option value="Angel">Angel</option>
                            <option value="Bronwen">Bronwen</option>
                            <option value="Cayra">Cayra</option>
                            <option value="Dalia">Dalia</option>
                            <option value="Deborah">Deborah</option>
                            <option value="Emma">Emma</option>
                            <option value="Francine">Francine</option>
                            <option value="Gianny">Gianny</option>
                            <option value="Ilana">Ilana</option>
                            <option value="Jayne">Jayne</option>
                            <option value="Joseph">Joseph</option>
                            <option value="Laura">Laura</option>
                            <option value="Monique">Monique</option>
                            <option value="Rebecca">Rebecca</option>
                            <option value="Tara">Tara</option>
                            <option value="Tracey">Tracey</option>
                            <option value="Trudy">Trudy</option>
                            <option value="custom">Custom Signature</option>
                        </select>
                        <input type="text" id="custom-agent-name" class="form-control" style="display: none;" placeholder="Enter Custom Agent Name" onchange="updateEmailTemplate(); saveState();">
                    </div>
                    <div class="form-group">
                        <label for="agent-email">Agent Email</label>
                        <input type="email" id="agent-email" class="form-control" value="reservations@bradleytravelstore.com" onchange="saveState();">
                    </div>
                    <div class="form-group">
                        <label for="agent-phone">Agent Phone</label>
                        <input type="text" id="agent-phone" class="form-control" value="020 3355 5060" onchange="saveState();">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email-template">Email Template</label>
                    <div id="email-template" class="email-template" contenteditable="false">Email template will be generated here</div>
                </div>
                
                <div class="output-format-buttons">
                    <button id="edit-btn" class="btn" onclick="handleEdit()">Edit Email</button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Bradley Travelstore</h3>
                    <p>Compare prices across multiple travel websites and find the best deals for your clients.</p>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p>Email: info@bradleytravelstore.com</p>
                    <p>Phone: 0203 633 0210</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#customer">Customer Info</a></li>
                        <li><a href="#hotel">Hotel Quote</a></li>
                        <li><a href="#flight">Flight Quote</a></li>
                        <li><a href="#email">Email Generator</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Bradley Travelstore. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <datalist id="roomTypes">
        <option value="Standard room">
        <option value="Standard Double room">
        <option value="Standard Twin room">
        <option value="Standard Pool View room">
        <option value="Standard Sea View room">
        <option value="Partial Sea View room">
        <option value="Pool View room">
        <option value="Sea View room">
        <option value="Superior room">
        <option value="Deluxe room">
        <option value="Garden room">
        <option value="Junior Suite">
        <option value="Suite">
    </datalist>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let currentDeliveryOption = 'email';
        let isEditing = false;
        let hotelQuoteSections = [];
        let usedQuoteNumbers = new Set();
        let hotelQuoteCounter = 0;
        let flightQuoteSections = [];
        let usedFlightQuoteNumbers = new Set();
        let flightQuoteCounter = 0;
        let roomsData = [];

        const inputNormalizationMap = {
            "0.89": 0.11
        };

        const agentDetails = {
            'Adam': { phone: '020 3355 5060', email: 'reservations@bradleytravelstore.com', website: 'bradleytravelstore.com' },
            'Alicia': { phone: '07864 998282', email: 'alicia@bradleytravelstore.com', website: 'bradleytravelstore.com/alicia-wyles' },
            'Andy': { phone: '07825 349055', email: 'andy@bradleytravelstore.com', website: 'bradleytravelstore.com/andy-cromar' },
            'Angel': { phone: '020 3355 5060', email: 'reservations@bradleytravelstore.com', website: 'bradleytravelstore.com' },
            'Bronwen': { phone: '07712 607356', email: 'Bronwen@bradleytravelstore.com', website: 'bradleytravelstore.com/Bronwen-Smith' },
            'Cayra': { phone: '07761 757630', email: 'cayra@bradleytravelstore.com', website: 'bradleytravelstore.com/cayra-gaskin-morris' },
            'Dalia': { phone: '07922 794683', email: 'dalia@bradleytravelstore.com', website: 'bradleytravelstore.com/dalia-cohen' },
            'Deborah': { phone: '07956 454680', email: 'deborah@bradleytravelstore.com', website: 'bradleytravelstore.com/deborah-roberts' },
            'Emma': { phone: '07881 487081', email: 'Emma@bradleytravelstore.com', website: 'bradleytravelstore.com/Emma-Morris' },
            'Francine': { phone: '07944 187054', email: 'francine@bradleytravelstore.com', website: 'bradleytravelstore.com/francine-ryan' },
            'Gianny': { phone: '020 3355 5060', email: 'reservations@bradleytravelstore.com', website: 'bradleytravelstore.com' },
            'Ilana': { phone: '+972 54 873 4585', email: 'ilana@bradleytravelstore.com', website: 'bradleytravelstore.com/ilanashalev' },
            'Jayne': { phone: '07712 836610', email: 'jayne@bradleytravelstore.com', website: 'bradleytravelstore.com/jaynelandsman' },
            'Joseph': { phone: '020 3355 5060', email: 'reservations@bradleytravelstore.com', website: 'bradleytravelstore.com' },
            'Laura': { phone: '07962 394030', email: 'laura@bradleytravelstore.com', website: 'bradleytravelstore.com/laura-myers' },
            'Monique': { phone: '07887 953005', email: 'monique@bradleytravelstore.com', website: 'bradleytravelstore.com/monique-plein' },
            'Rebecca': { phone: '07909 913997', email: 'rebecca@bradleytravelstore.com', website: 'bradleytravelstore.com/rebecca-johnstone' },
            'Tara': { phone: '07956 263778', email: 'tara@bradleytravelstore.com', website: 'bradleytravelstore.com/tara-yadid' },
            'Tracey': { phone: '07743 025088', email: 'Tracey@bradleytravelstore.com', website: 'bradleytravelstore.com/Tracey-Borthwick' },
            'Trudy': { phone: '07864 255166', email: 'Trudy@bradleytravelstore.com', website: 'bradleytravelstore.com/Trudy-Stewart' }
        };

        function initCancellationPickers(root=document) {
            root.querySelectorAll('.cancellation-deadline').forEach(function(input) {
                if (!input._flatpickr) {
                    flatpickr(input, {
                        dateFormat: "Y-m-d",
                        minDate: "today",
                        onChange: function(selectedDates, dateStr) {
                            const row = input.closest('tr');
                            if (row) {
                                const section = row.closest('.hotel-quote-section, .flight-quote-section');
                                if (section) {
                                    const sectionId = section.id;
                                    if (section.classList.contains('hotel-quote-section')) {
                                        calculateBalanceDueDateForSection(sectionId);
                                    } else {
                                        updateFlightQuoteTotals(sectionId);
                                    }
                                }
                            }
                            updateEmailTemplate();
                            saveState();
                        }
                    });
                }
            });
        }

        const flightDatesFp = flatpickr("#flight-dates", {
            mode: "range",
            dateFormat: "Y-m-d",
            minDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                updateEmailTemplate();
                saveState();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            updateCommission();
            updateAgentSignature();
            updateEmailTemplate();
            toggleSectionsBasedOnBookingType();
            loadState();
            // Initialize rooms
            initializeRooms();
            // Add initial hotel quote section
            addHotelQuoteSection();
            // Add initial flight quote section
            addFlightQuoteSection();
            addOptionalExtra(); // Add one initial optional extra
            calculateAllBalanceDueDates();
            ensureAllRoomsHaveSuppliers();
        });

        function initializeRooms() {
            changeRoomCount(0); // Initialize with 1 room
        }

function changeRoomCount(delta) {
    const oldCount = parseInt(document.getElementById('rooms-count').textContent);
    let count = oldCount + delta;
    if (count < 1) count = 1; // Minimum 1 room
    document.getElementById('rooms-count').textContent = count;
    
    // Update roomsData
    if (count < oldCount) {
        roomsData = roomsData.slice(0, count);
    } else if (count > oldCount) {
        for (let newRoomIndex = oldCount; newRoomIndex < count; newRoomIndex++) {
            roomsData.push({
                adults: 2,
                children: 0,
                infants: 0,
                childAges: []
            });
        }
    }
    
    updateRoomsContainer();
    
    ensureAllRoomsHaveSuppliers();
    
    updateTotals();
    updateEmailTemplate();
    saveState();
}

function ensureAllRoomsHaveSuppliers() {
    const count = roomsData.length;
    hotelQuoteSections.forEach(sectionId => {
        const roomsContainer = document.getElementById(`${sectionId}-rooms-container`);
        if (!roomsContainer) return;
        // Remove extra room comparisons if count decreased
        const currentDivs = roomsContainer.querySelectorAll('.room-comparison');
        if (currentDivs.length > count) {
            for (let i = count; i < currentDivs.length; i++) {
                const div = roomsContainer.querySelector(`.room-comparison[data-room="${i}"]`);
                if (div) div.remove();
            }
        }
        // Ensure each room has comparison and at least one supplier
        for (let i = 0; i < count; i++) {
            let comp = document.getElementById(`${sectionId}-room-${i}-comparison`);
            if (!comp) {
                addRoomComparison(sectionId, i);
                comp = document.getElementById(`${sectionId}-room-${i}-comparison`);
            }
            const compId = `${sectionId}-room-${i}-comparison`;
            if (comp && !comp.querySelector('.supplier-table-row')) {
                addHotelSupplier(sectionId, i, {});
                autoSelectBestForComparison(compId);
            } else {
                autoSelectBestForComparison(compId);
            }
        }
        sortAllRoomsInSection(sectionId);
    });
}

function autoSelectBestForComparison(compId) {
    const comparison = document.getElementById(compId);
    if (!comparison) return;
    const rows = comparison.querySelectorAll('.supplier-table-row');
    if (rows.length === 0) return;
    const completeRows = Array.from(rows).filter(row => isPolicyComplete(row)).map(row => ({
        row,
        price: parseFloat(row.querySelector('.selling-price').value) || Infinity
    }));
    if (completeRows.length > 0) {
        completeRows.sort((a, b) => a.price - b.price);
        const bestRow = completeRows[0].row;
        const bestCb = bestRow.querySelector('input[id$="-best"]');
        if (bestCb && !bestCb.checked) {
            bestCb.checked = true;
            toggleBestPrice(bestRow.id);
        }
    }
}

function addRoomComparison(sectionId, roomIndex) {
    const roomsContainer = document.getElementById(`${sectionId}-rooms-container`);
    if (roomsContainer.querySelector(`.room-comparison[data-room="${roomIndex}"]`)) return;
    const roomDiv = document.createElement('div');
    roomDiv.className = 'room-comparison';
    roomDiv.setAttribute('data-room', roomIndex);
    roomDiv.innerHTML = `
        <h4>Supplier Comparison Room ${roomIndex + 1}</h4>
        <div id="${sectionId}-room-${roomIndex}-comparison" class="supplier-comparison"></div>
        <div class="comparison-controls">
            <button class="btn" onclick="addHotelSupplier('${sectionId}', ${roomIndex})"><i class="fas fa-plus"></i> Add Supplier</button>
        </div>
    `;
    roomsContainer.appendChild(roomDiv);
}

function sortAllRoomsInSection(sectionId) {
    const count = roomsData.length;
    for (let i = 0; i < count; i++) {
        sortAndHighlightComparison(`${sectionId}-room-${i}-comparison`);
    }
}

function sortAndHighlightComparison(compId) {
    autoSelectBestForComparison(compId);
    const comparison = document.getElementById(compId);
    if (!comparison) return;
    const rows = comparison.querySelectorAll('.supplier-table-row');
    
    // Highlight best without reordering
    rows.forEach(row => {
        row.classList.remove('best-price');
        const checkbox = row.querySelector('input[id$="-best"]');
        if (checkbox && checkbox.checked) {
            row.classList.add('best-price');
        }
    });
}

function updateRoomsContainer() {
    const count = parseInt(document.getElementById('rooms-count').textContent);
    const container = document.getElementById('rooms-container');
    container.innerHTML = '';

    for (let i = 0; i < count; i += 2) {
        const row = document.createElement('div');
        row.className = 'rooms-row';
        for (let j = 0; j < 2 && (i + j) < count; j++) {
            const roomIndex = i + j;
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-type';
            roomDiv.id = `room-${roomIndex}`;
            const roomData = roomsData[roomIndex];
            roomDiv.innerHTML = `
                <div class="room-header">
                    <h4 class="room-number">Room ${roomIndex + 1}</h4>
                </div>
                <div class="people-selector">
                    <div class="people-type">
                        <h3>Adults</h3>
                        <div class="counter">
                            <button class="counter-btn" onclick="changeRoomOccupancy(${roomIndex}, 'adults', -1)">-</button>
                            <span id="room-${roomIndex}-adults-count" class="counter-value">${roomData.adults}</span>
                            <button class="counter-btn" onclick="changeRoomOccupancy(${roomIndex}, 'adults', 1)">+</button>
                        </div>
                    </div>
                    <div class="people-type">
                        <h3>Children</h3>
                        <div class="counter">
                            <button class="counter-btn" onclick="changeRoomOccupancy(${roomIndex}, 'children', -1)">-</button>
                            <span id="room-${roomIndex}-children-count" class="counter-value">${roomData.children}</span>
                            <button class="counter-btn" onclick="changeRoomOccupancy(${roomIndex}, 'children', 1)">+</button>
                        </div>
                    </div>
                    <div class="people-type">
                        <h3>Infants</h3>
                        <div class="counter">
                            <button class="counter-btn" onclick="changeRoomOccupancy(${roomIndex}, 'infants', -1)">-</button>
                            <span id="room-${roomIndex}-infants-count" class="counter-value">${roomData.infants}</span>
                            <button class="counter-btn" onclick="changeRoomOccupancy(${roomIndex}, 'infants', 1)">+</button>
                        </div>
                        <div class="age-label">Under 2 years old</div>
                    </div>
                </div>
                <div id="room-${roomIndex}-child-ages" class="child-ages-container"></div>
            `;
            row.appendChild(roomDiv);
        }
        container.appendChild(row);
        // Update child ages for rooms in this row
        for (let j = 0; j < 2 && (i + j) < count; j++) {
            const roomIndex = i + j;
            updateRoomChildAges(roomIndex);
        }
    }
}
function changeRoomOccupancy(roomIndex, type, delta) {
    const countElement = document.getElementById(`room-${roomIndex}-${type}-count`);
    let count = parseInt(countElement.textContent);
    count += delta;
    if (count < 0) count = 0;
    countElement.textContent = count;
    // Update roomsData
    roomsData[roomIndex][type] = count;
    if (type === 'children') {
        updateRoomChildAges(roomIndex);
    }
    updateTotals();
    updateEmailTemplate();
    saveState();
}

function updateRoomChildAges(roomIndex) {
            const count = parseInt(document.getElementById(`room-${roomIndex}-children-count`).textContent);
            const container = document.getElementById(`room-${roomIndex}-child-ages`);
            container.innerHTML = '';
            roomsData[roomIndex].childAges = [];

            for (let j = 0; j < count; j++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'child-age-input form-control';
                input.placeholder = `Child ${j+1} Age`;
                input.min = '0';
                input.max = '17';
                input.onchange = function() {
                    validateRoomChildAges(roomIndex);
                    updateEmailTemplate();
                    saveState();
                };
                container.appendChild(input);
                roomsData[roomIndex].childAges.push('');
            }
            updateEmailTemplate();
            saveState();
        }

        function validateRoomChildAges(roomIndex) {
            const childInputs = document.querySelectorAll(`#room-${roomIndex}-child-ages .child-age-input`);
            let allValid = true;
            
            childInputs.forEach((input, j) => {
                const age = parseInt(input.value);
                if (isNaN(age) || age < 0 || age > 17) {
                    input.style.borderColor = 'var(--danger)';
                    allValid = false;
                } else {
                    input.style.borderColor = '';
                    roomsData[roomIndex].childAges[j] = input.value;
                }
            });
            
            return allValid;
        }

        function getTotalTravelers() {
            let totalAdults = 0, totalChildren = 0, totalInfants = 0, allChildAges = [];
            roomsData.forEach(room => {
                totalAdults += room.adults;
                totalChildren += room.children;
                totalInfants += room.infants;
                allChildAges = allChildAges.concat(room.childAges.filter(age => age));
            });
            return { adults: totalAdults, children: totalChildren, infants: totalInfants, childAges: allChildAges };
        }

        function getNextQuoteNumber() {
            let number = 1;
            while (usedQuoteNumbers.has(number)) {
                number++;
            }
            return number;
        }

        function getNextFlightQuoteNumber() {
            let number = 1;
            while (usedFlightQuoteNumbers.has(number)) {
                number++;
            }
            return number;
        }

        function toggleSectionsBasedOnBookingType() {
            const bookingType = document.getElementById('booking-type').value;
            const hotelSection = document.getElementById('hotel');
            const flightSection = document.getElementById('flight');
            const optionalExtrasSection = document.getElementById('optional-extras');

            if (bookingType === 'hotel') {
                hotelSection.style.display = 'block';
                flightSection.style.display = 'none';
                if (optionalExtrasSection) optionalExtrasSection.style.display = 'none';
            } else { // package
                hotelSection.style.display = 'block';
                flightSection.style.display = 'block';
                if (optionalExtrasSection) optionalExtrasSection.style.display = 'block';
            }
            updateTotals();
            updateEmailTemplate();
        }

function toggleSection(sectionId) {
    console.log('Toggle clicked for section:', sectionId);  // Logs if click fires
    const section = document.getElementById(sectionId);
    
    if (!section) {
        console.log('ERROR: Section element not found for ID:', sectionId);
        return;
    }
    
    console.log('Current classes on section:', section.className);  // Shows initial state
    
    if (section.classList.contains('expanded')) {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        console.log('Switched to collapsed');
    } else {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        console.log('Switched to expanded');
    }
    
    console.log('New classes on section:', section.className);  // Confirms change
    saveState();
}

        function selectDeliveryOption(element, option) {
            document.querySelectorAll('.delivery-option').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
            currentDeliveryOption = option;
            if (!isEditing) {
                updateEmailTemplate();
            }
            saveState();
        }

        function updateAgentSignature() {
            const select = document.getElementById('agent-name');
            const agent = select.value;
            const customInput = document.getElementById('custom-agent-name');
            if (agent === 'custom') {
                customInput.style.display = 'block';
                const name = prompt('Enter Agent Name:');
                if (name) {
                    customInput.value = name;
                }
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
                if (agent !== 'custom') {
                    const details = agentDetails[agent];
                    if (details) {
                        document.getElementById('agent-email').value = details.email;
                        document.getElementById('agent-phone').value = details.phone;
                    }
                }
            }
            updateEmailTemplate();
            saveState();
        }

        function updateCommission() {
            const commissionInput = document.getElementById('commission-rate').value;
            const commissionRate = parseCommissionRate(commissionInput);
            
            if (commissionRate !== null) {
                const divisor = (1 - commissionRate).toFixed(3);
                document.getElementById('commission-display-text').textContent = 
                    `${(commissionRate * 100).toFixed(2)}% (divisor ${divisor})`;
                
                // Update all suppliers
                document.querySelectorAll('.supplier-table-row, .flight-leg-row').forEach(item => {
                    const id = item.id;
                    if (id) updateSupplierPrice(id);
                });
                
                updateTotals();
                updateEmailTemplate();
                saveState();
            }
        }

        function parseCommissionRate(s) {
            if (!s) return null;
            
            s = s.trim();
            let value;
            
            if (s.includes('%')) {
                value = parseFloat(s.replace('%', '')) / 100;
            } else {
                value = parseFloat(s);
            }
            
            if (isNaN(value)) {
                alert('Invalid commission rate. Please enter a valid number or percentage.');
                return null;
            }
            
            if (inputNormalizationMap.hasOwnProperty(s)) {
                console.log(`Commission input "${s}" was remapped to ${inputNormalizationMap[s]}`);
                return inputNormalizationMap[s];
            }
            
            if (value > 1 && value <= 100) {
                return value / 100;
            } else if (value >= 0 && value <= 1) {
                return value;
            } else {
                alert('Commission must be between 0% and 100%.');
                return null;
            }
        }

        function calculateCommission(baseAmount, commissionRate) {
            if (commissionRate >= 1 || commissionRate < 0) {
                return { commissionAmount: 0, sellingPrice: baseAmount };
            }
            const sellingPrice = roundToTwo(baseAmount / (1 - commissionRate));
            const commissionAmount = roundToTwo(sellingPrice * commissionRate);
            
            return {
                commissionAmount,
                sellingPrice
            };
        }

        function roundToTwo(num) {
            return Math.round(num * 100) / 100;
        }

        function getCancellationText(cancelPolicy, cancelFee, cancellationDeadline) {
            if (!cancelPolicy) {
                return "";
            }
            if (cancelPolicy === 'non-refundable') {
                return "Non-refundable";
            } else if (cancelPolicy === 'refundable' || cancelPolicy === 'refundable-with-fee') {
                let text = '';
                if (cancellationDeadline) {
                    let displayDate = new Date(cancellationDeadline);
                    displayDate.setDate(displayDate.getDate() - 7);
                    const formatted = formatDate(displayDate.toISOString().split('T')[0]);
                    text += `Free cancellation until ${formatted}`;
                }
                if (cancelFee > 0) {
                    if (text) text += ' or ';
                    text += `£${cancelFee.toFixed(2)} fee after`;
                }
                return text || 'Refundable with fee';
            }
            return "";
        }

        function addOptionalExtra() {
            const list = document.getElementById('optional-extras-list');
            const id = 'extra-' + Date.now();
            const div = document.createElement('div');
            div.className = 'optional-extra-item';
            div.id = id;
            div.innerHTML = `
                <input type="text" class="form-control" placeholder="Optional Extra Name (e.g., Return private airport transfers add £5)" onchange="updateEmailTemplate(); saveState();">
                <input type="number" class="form-control" placeholder="0.00" step="0.01" onchange="updateEmailTemplate(); saveState();">
                <input type="checkbox" onchange="updateEmailTemplate(); saveState();"> Include in Email
                <button class="btn btn-danger btn-sm" onclick="removeOptionalExtra('${id}')"><i class="fas fa-trash"></i></button>
            `;
            list.appendChild(div);
            updateEmailTemplate();
            saveState();
        }

        function removeOptionalExtra(id) {
            const item = document.getElementById(id);
            if (item) {
                item.remove();
                updateEmailTemplate();
                saveState();
            }
        }

        function addHotelQuoteSection(data = {}) {
    const container = document.getElementById('hotel-quotes-container');
    const number = data.number || getNextQuoteNumber();
    usedQuoteNumbers.add(number);
    const sectionId = 'hotel-quote-' + number;
    const card = document.createElement('div');
    card.className = 'card expanded hotel-quote-section';
    card.id = sectionId;
    const includeChecked = data.include !== undefined ? data.include : true;
    const dest = data.destination || '';
    const html = `
        <div class="section-toggle" onclick="toggleSection('${sectionId}')">
            <h2 class="section-title">Hotel Quote ${number}</h2>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="section-content">
            <div class="hotel-quote-header">
                <label class="checkbox-group">
                    <input type="checkbox" class="quote-include" ${includeChecked ? 'checked' : ''} onchange="toggleQuoteInclude('${sectionId}'); updateTotals(); updateEmailTemplate(); saveState();"> Include in Quote
                </label>
                <button class="btn btn-danger btn-sm" onclick="removeHotelQuoteSection('${sectionId}', ${number})"><i class="fas fa-trash"></i> Remove</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Check-in & Check-out Dates</label>
                    <input type="text" class="form-control hotel-checkin" placeholder="Select dates" value="${data.checkin || ''}">
                </div>
                <div class="form-group">
                    <label>Nights</label>
                    <input type="number" class="form-control hotel-nights" placeholder="Nights" readonly value="${data.nights || ''}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="${sectionId}-hotel-name">Hotel Name</label>
                    <input type="text" id="${sectionId}-hotel-name" class="form-control" placeholder="Hotel name" value="${data.hotelName || ''}" onchange="updateHotelTitle('${sectionId}'); updateEmailTemplate(); saveState();">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Destination</label>
                    <input type="text" id="${sectionId}-destination" class="form-control" placeholder="Destination" value="${dest}" onchange="updateEmailTemplate(); saveState();">
                </div>
            </div>
            <h4>Supplier Comparisons</h4>
            <div id="${sectionId}-rooms-container">
                <!-- Dynamic room comparisons -->
            </div>
            <div class="comparison-controls">
                <button class="btn" onclick="copyHotelComparison('${sectionId}')"><i class="fas fa-copy"></i> Copy Comparison</button>
            </div>
            <div class="section-totals">
                <h3>Local taxes payable locally</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Currency</label>
                        <input type="text" id="${sectionId}-excludes-currency" class="form-control" placeholder="e.g., EUR" value="${data.excludesCurrency || ''}" onchange="updateEmailTemplate(); saveState();">
                    </div>
                    <div class="form-group">
                        <label>Amount Per Night</label>
                        <input type="number" id="${sectionId}-excludes-amount" class="form-control" placeholder="e.g., 15" step="0.01" value="${data.excludesAmount || ''}" onchange="updateEmailTemplate(); saveState();">
                    </div>
                </div>
                <div class="totals-row">
                    <span class="totals-label">Total Net:</span>
                    <span id="${sectionId}-total-net" class="totals-value">£0.00</span>
                </div>
                <div class="totals-row">
                    <span class="totals-label">Total Selling - Exact:</span>
                    <span id="${sectionId}-total-selling-exact" class="totals-value">£0.00</span>
                </div>
                <div class="totals-row">
                    <span class="totals-label">Total Selling - Rounded:</span>
                    <span id="${sectionId}-total-selling-rounded" class="totals-value">£0.00</span>
                </div>
            </div>
        </div>
    `;
    card.innerHTML = html;
    container.appendChild(card);
    hotelQuoteSections.push(sectionId);
    hotelQuoteCounter = Math.max(hotelQuoteCounter, number);
    initQuoteDates(sectionId, data.checkin);
    // Add room comparisons
    const numRooms = parseInt(document.getElementById('rooms-count').textContent);
    for (let i = 0; i < numRooms; i++) {
        addRoomComparison(sectionId, i);
    }
    // Populate saved suppliers if any
    if (data.suppliers && data.suppliers.length > 0) {
        data.suppliers.forEach(supData => {
            const roomIndex = supData.roomIndex || 0;
            if (roomIndex < numRooms) {
                addHotelSupplier(sectionId, roomIndex, supData);
            }
        });
    }
    // Ensure each room has at least one supplier
    for (let i = 0; i < numRooms; i++) {
        const comp = document.getElementById(`${sectionId}-room-${i}-comparison`);
        if (comp && !comp.querySelector('.supplier-table-row')) {
            addHotelSupplier(sectionId, i, {});
        }
    }
    sortAllRoomsInSection(sectionId);
    for (let i = 0; i < numRooms; i++) {
        autoSelectBestForComparison(`${sectionId}-room-${i}-comparison`);
    }
    initCancellationPickers(card);
    updateQuoteTotals(sectionId);
    calculateBalanceDueDateForSection(sectionId);
    updateHotelTitle(sectionId);
    updateTotals();
    updateEmailTemplate();
    saveState();
}

function updateHotelTitle(sectionId) {
    const hotelName = document.getElementById(`${sectionId}-hotel-name`).value.trim();
    const destination = document.getElementById(`${sectionId}-destination`).value.trim();
    const titleEl = document.querySelector(`#${sectionId} .section-title`);
    if (titleEl) {
        if (hotelName && destination) {
            titleEl.textContent = `${hotelName}, ${destination}`;
        } else if (hotelName) {
            titleEl.textContent = `${hotelName}`;
        } else if (destination) {
            titleEl.textContent = `Hotel Quote ${sectionId.split('-')[2]} - ${destination}`;
        } else {
            const number = sectionId.split('-')[2];
            titleEl.textContent = `Hotel Quote ${number}`;
        }
    }
}

        function updateAllHotelDestinations() {
            const dest = document.getElementById('destination').value || '';
            hotelQuoteSections.forEach(id => {
                const span = document.getElementById(`${id}-destination`);
                if (span) span.textContent = dest;
            });
        }

        function initQuoteDates(sectionId, initialValue = '') {
            const checkinInput = document.querySelector(`#${sectionId} .hotel-checkin`);
            if (checkinInput && !checkinInput._flatpickr) {
                flatpickr(checkinInput, {
                    mode: "range",
                    dateFormat: "d-M-y",
                    minDate: "today",
                    defaultDate: initialValue ? initialValue.split(' to ') : undefined,
                    onChange: function(selectedDates, dateStr, instance) {
                        const nightsInput = document.querySelector(`#${sectionId} .hotel-nights`);
                        if (selectedDates.length === 2 && nightsInput) {
                            const nights = Math.floor((selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24));
                            nightsInput.value = nights;
                        }
                        updateEmailTemplate();
                        saveState();
                    }
                });
            }
        }

        function removeHotelQuoteSection(sectionId, number) {
            if (confirm('Are you sure you want to remove this hotel quote section?')) {
                usedQuoteNumbers.delete(number);
                const section = document.getElementById(sectionId);
                if (section) {
                    section.remove();
                    hotelQuoteSections = hotelQuoteSections.filter(id => id !== sectionId);
                    updateTotals();
                    updateEmailTemplate();
                    calculateAllBalanceDueDates();
                    saveState();
                }
            }
        }

        function toggleQuoteInclude(sectionId) {
            const checkbox = document.querySelector(`#${sectionId} .quote-include`);
            const section = document.getElementById(sectionId);
            if (checkbox.checked) {
                section.style.opacity = '1';
            } else {
                section.style.opacity = '0.5';
            }
            if (section.classList.contains('hotel-quote-section')) {
                updateQuoteTotals(sectionId);
                calculateBalanceDueDateForSection(sectionId);
            } else if (section.classList.contains('flight-quote-section')) {
                updateFlightQuoteTotals(sectionId);
            }
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

       function addHotelSupplier(sectionId, roomIndex, data = {}) {
    const compId = `${sectionId}-room-${roomIndex}-comparison`;
    const comparison = document.getElementById(compId);
    if (!comparison) return;
    let table = comparison.querySelector('table');
    if (!table) {
        table = document.createElement('table');
        createTableHeader('hotel', table);
        comparison.appendChild(table);
    }
    const tbody = table.querySelector('tbody') || document.createElement('tbody');
    if (!table.querySelector('tbody')) table.appendChild(tbody);

    const supId = data.id || `${sectionId}-supplier-${Date.now()}-${roomIndex}`;
    const tr = document.createElement('tr');
    tr.id = supId;
    tr.classList.add('supplier-table-row');
    tr.setAttribute('data-room', roomIndex);
    const includeEmailChecked = data.includeEmail !== undefined ? data.includeEmail : false;
    tr.innerHTML = `
        <td>
            <input type="text" class="form-control supplier-name" placeholder="Supplier Name" value="${data.supplierName || ''}" onchange="updateEmailTemplate(); saveState();">
        </td>
        <td><input type="number" class="form-control net-price" step="0.01" placeholder="0.00" value="${data.netPrice || ''}" onchange="updateSupplierPrice('${supId}'); saveState();"></td>
        <td><input type="text" class="form-control commission-rate" placeholder="Use global" value="${data.commissionRate || ''}" onchange="updateSupplierPrice('${supId}'); saveState();"></td>
        <td><input type="text" class="form-control selling-price" readonly placeholder="0.00" value=""></td>
        <td><input type="text" class="form-control commission-amount" readonly placeholder="0.00" value=""></td>
        <td><input type="text" class="form-control room-type" list="roomTypes" placeholder="Room Type" value="${data.roomType || ''}" onchange="updateEmailTemplate(); saveState();"></td>
        <td><input type="number" class="form-control rooms" min="1" value="${data.rooms || 1}" onchange="updateTotals(); updateEmailTemplate(); saveState();"></td>
        <td><select class="form-control board-basis" onchange="updateEmailTemplate(); saveState();">
            <option ${data.boardBasis === 'Room Only' ? 'selected' : ''}>Room Only</option>
            <option ${data.boardBasis === 'Bed & Breakfast' ? 'selected' : ''}>Bed & Breakfast</option>
            <option ${data.boardBasis === 'Half Board' ? 'selected' : ''}>Half Board</option>
            <option ${data.boardBasis === 'Full Board' ? 'selected' : ''}>Full Board</option>
            <option ${data.boardBasis === 'All Inclusive' ? 'selected' : ''}>All Inclusive</option>
        </select></td>
        <td>
            <select class="form-control cancellation-policy" onchange="toggleCancellationFee('${supId}'); calculateBalanceDueDateForSection('${sectionId}'); sortAndHighlightComparison('${compId}'); updateEmailTemplate(); saveState();">
                <option value="" selected>-- Select Policy --</option>
                <option value="non-refundable" ${data.cancellationPolicy === 'non-refundable' ? 'selected' : ''}>Non-Refundable</option>
                <option value="refundable" ${data.cancellationPolicy === 'refundable' ? 'selected' : ''}>Refundable</option>
                <option value="refundable-with-fee" ${data.cancellationPolicy === 'refundable-with-fee' ? 'selected' : ''}>Refundable with Fee</option>
            </select>
            <div class="cancellation-deadline-group" style="display:none;">
                <input type="text" class="form-control cancellation-deadline" placeholder="Select cancellation deadline" value="${data.cancellationDeadline || ''}" onchange="calculateBalanceDueDateForSection('${sectionId}'); sortAndHighlightComparison('${compId}'); updateEmailTemplate(); saveState();">
            </div>
            <div class="cancellation-fee-group" style="display:none;">
                <input type="number" class="form-control cancellation-fee" step="0.01" placeholder="0.00" value="${(data.cancellationFee || 0).toFixed(2)}" onchange="sortAndHighlightComparison('${compId}'); updateEmailTemplate(); saveState();">
            </div>
        </td>
        <td style="text-align: center;">
            <div>
                <input type="checkbox" id="${supId}-best" ${data.best ? 'checked' : ''} onchange="toggleBestPrice('${supId}'); calculateBalanceDueDateForSection('${sectionId}'); updateEmailTemplate();">
                <br>
                <span class="best-price-badge" style="display: none; color: var(--success); font-size: 0.7rem; font-weight: bold;">Best Price</span>
            </div>
        </td>
        <td class="upgrade-cell">
            <input type="checkbox" id="${supId}-upgrade" ${data.upgrade ? 'checked' : ''} onchange="toggleUpgrade('${supId}'); updateEmailTemplate(); saveState();">
            <div class="upgrade-modes" style="display: ${data.upgrade ? 'block' : 'none'};">
                <label><input type="checkbox" id="${supId}-upgrade-auto" ${data.upgradeAuto ? 'checked' : ''} onchange="handleUpgradeMode('${supId}', 'auto'); updateEmailTemplate(); saveState();"> Auto-upgrade from base</label>
                <label><input type="checkbox" id="${supId}-upgrade-manual" ${data.upgradeManual ? 'checked' : ''} onchange="handleUpgradeMode('${supId}', 'manual'); updateEmailTemplate(); saveState();"> Manual upgrade</label>
            </div>
            <div id="${supId}-auto-section" style="display: ${data.upgrade && data.upgradeAuto ? 'block' : 'none'}; margin-top: 5px;">
                <small>Upgrade amount: <span id="${supId}-auto-amount" class="auto-upgrade-amount">£0.00</span></small>
            </div>
            <div id="${supId}-manual-section" style="display: ${data.upgrade && data.upgradeManual ? 'block' : 'none'}; margin-top: 5px;">
                <input type="text" class="form-control upgrade-desc" placeholder="Upgrade description" value="${data.upgradeDesc || ''}" style="margin-bottom: 5px;" onchange="updateEmailTemplate(); saveState();">
                <input type="number" class="form-control upgrade-amount" step="0.01" placeholder="0.00" value="${(data.upgradeAmount || 0).toFixed(2)}" onchange="updateEmailTemplate(); saveState();">
            </div>
        </td>
        <td><input type="checkbox" id="${supId}-include-email" ${includeEmailChecked ? 'checked' : ''} onchange="toggleIncludeEmail('${supId}'); updateEmailTemplate();"></td>
        <td>
            <button class="btn btn-danger btn-sm" onclick="removeSupplier('${supId}')"><i class="fas fa-trash"></i></button>
        </td>
    `;
    tbody.appendChild(tr);
    updateSupplierPrice(supId);
    initCancellationPickers(tr);
    toggleCancellationFee(supId);
    if (data.best) toggleBestPrice(supId);
    if (data.upgrade) toggleUpgrade(supId);
    if (data.upgradeAuto) {
        document.getElementById(supId + '-upgrade-auto').checked = true;
        handleUpgradeMode(supId, 'auto');
    }
    if (data.upgradeManual) {
        document.getElementById(supId + '-upgrade-manual').checked = true;
        handleUpgradeMode(supId, 'manual');
    }
    sortAndHighlightComparison(compId);
    updateQuoteTotals(sectionId);
}

        function toggleBestPrice(id) {
            const checkbox = document.getElementById(`${id}-best`);
            const row = document.getElementById(id);
            const badge = row.querySelector('.best-price-badge');
            if (!row) return;
            const comparison = row.closest('.supplier-comparison');
            if (!comparison) return;
            const allRows = comparison.querySelectorAll('.supplier-table-row');
            let previousBestRow = null;
            allRows.forEach(r => {
                const cb = r.querySelector('input[id$="-best"]');
                if (cb && cb.checked && r.id !== id) {
                    previousBestRow = r;
                }
            });
            if (checkbox.checked) {
                if (!isPolicyComplete(row)) {
                    checkbox.checked = false;
                    if (badge) badge.style.display = 'none';
                    alert('Please select cancellation terms first.');
                    return;
                }
                const includeEmailCb = row.querySelector('input[id$="-include-email"]');
                if (includeEmailCb) includeEmailCb.checked = true;
                if (previousBestRow && previousBestRow !== row) {
                    const prevInc = previousBestRow.querySelector('input[id$="-include-email"]');
                    if (prevInc) prevInc.checked = false;
                }
                allRows.forEach(r => {
                    if (r.id !== id) {
                        const otherCb = r.querySelector('input[id$="-best"]');
                        if (otherCb && otherCb.checked) {
                            otherCb.checked = false;
                            r.classList.remove('best-price');
                            const otherBadge = r.querySelector('.best-price-badge');
                            if (otherBadge) otherBadge.style.display = 'none';
                        }
                    }
                });
                row.classList.add('best-price');
                if (badge) badge.style.display = 'block';
            } else {
                row.classList.remove('best-price');
                const includeEmailCb = row.querySelector('input[id$="-include-email"]');
                if (includeEmailCb) includeEmailCb.checked = false;
                if (badge) badge.style.display = 'none';
            }
            const section = row.closest('.hotel-quote-section');
            if (section) {
                calculateBalanceDueDateForSection(section.id);
            }
            updateEmailTemplate();
            saveState();
        }

        function toggleIncludeEmail(id) {
            const checkbox = document.getElementById(`${id}-include-email`);
            if (!checkbox) return;
            const row = document.getElementById(id);
            if (!row) return;
            const comparison = row.closest('.supplier-comparison');
            if (!comparison) return;
            if (checkbox.checked) {
                const allRows = comparison.querySelectorAll('.supplier-table-row');
                allRows.forEach(r => {
                    if (r.id !== id) {
                        const otherCheckbox = document.getElementById(`${r.id}-include-email`);
                        if (otherCheckbox) {
                            otherCheckbox.checked = false;
                        }
                    }
                });
            }
            const section = row.closest('.hotel-quote-section');
            if (section) {
                updateQuoteTotals(section.id);
            }
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

        function addFlightQuoteSection(data = {}) {
            const container = document.getElementById('flight-quotes-container');
            const number = data.number || getNextFlightQuoteNumber();
            usedFlightQuoteNumbers.add(number);
            const sectionId = 'flight-quote-' + number;
            const card = document.createElement('div');
            card.className = 'card expanded flight-quote-section';
            card.id = sectionId;
            const includeChecked = data.include !== undefined ? data.include : true;
            const html = `
                <div class="section-toggle" onclick="toggleSection('${sectionId}')">
                    <h2 class="section-title">Flight Quote ${number}</h2>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="flight-quote-header">
                        <label class="checkbox-group">
                            <input type="checkbox" class="quote-include" ${includeChecked ? 'checked' : ''} onchange="toggleQuoteInclude('${sectionId}'); updateTotals(); updateEmailTemplate(); saveState();"> Include in Quote
                        </label>
                        <button class="btn btn-danger btn-sm" onclick="removeFlightQuoteSection('${sectionId}', ${number})"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                    <h4>Flight Legs</h4>
                    <div id="${sectionId}-legs-container" class="flight-legs-comparison">
                        <!-- Dynamic legs table added here -->
                    </div>
                    <div class="comparison-controls">
                        <button class="btn" onclick="addFlightLeg('${sectionId}')"><i class="fas fa-plus"></i> Add Leg</button>
                        <button class="btn btn-secondary" onclick="copyFlightDetails('${sectionId}')"><i class="fas fa-copy"></i> Copy Flight Details</button>
                    </div>
                    <div class="section-totals">
                        <h3>Flight Totals</h3>
                        <div class="totals-row">
                            <span class="totals-label">Total Net:</span>
                            <span id="${sectionId}-total-net" class="totals-value">£0.00</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label">Total Selling - Exact:</span>
                            <span id="${sectionId}-total-selling-exact" class="totals-value">£0.00</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label">Total Selling - Rounded:</span>
                            <span id="${sectionId}-total-selling-rounded" class="totals-value">£0.00</span>
                        </div>
                    </div>
                </div>
            `;
            card.innerHTML = html;
            container.appendChild(card);
            flightQuoteSections.push(sectionId);
            flightQuoteCounter = Math.max(flightQuoteCounter, number);
            // Create table for legs
            const legsContainer = document.getElementById(`${sectionId}-legs-container`);
            let table = document.createElement('table');
            createFlightLegsTableHeader(table);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
            legsContainer.appendChild(table);
            // Add legs
            if (data.legs && data.legs.length > 0) {
                data.legs.forEach(legData => {
                    addFlightLeg(sectionId, legData);
                });
            } else {
                // Default: add Departure and Return
                addFlightLeg(sectionId, { legType: 'Departure Flight' });
                addFlightLeg(sectionId, { legType: 'Return Flight' });
            }
            initCancellationPickers(card);
            updateFlightQuoteTotals(sectionId);
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

        function createFlightLegsTableHeader(table) {
            const thead = document.createElement('thead');
            let thHTML = '<tr>';
            thHTML += `
                <th>Leg Type</th>
                <th>Airline</th>
                <th>Dep Airport</th>
                <th>Arr Airport</th>
                <th>Dep Time</th>
                <th>Arr Time</th>
                <th>Baggage</th>
                <th>Net (£)</th>
                <th>Comm Rate</th>
                <th>Selling (£)</th>
                <th>Comm Amt (£)</th>
                <th>Cancellation</th>
                <th>Upgrade</th>
                <th>Actions</th>
            `;
            thHTML += '</tr>';
            thead.innerHTML = thHTML;
            table.appendChild(thead);
        }

        function addFlightLeg(sectionId, data = {}) {
            const legsContainer = document.getElementById(`${sectionId}-legs-container`);
            const table = legsContainer.querySelector('table');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const id = data.id || `${sectionId}-leg-${Date.now()}`;
            const tr = document.createElement('tr');
            tr.id = id;
            tr.classList.add('flight-leg-row');
            tr.innerHTML = `
                <td>
                    <select class="form-control leg-type" onchange="updateEmailTemplate(); saveState();">
                        <option ${data.legType === 'Departure Flight' ? 'selected' : ''}>Departure Flight</option>
                        <option ${data.legType === 'Return Flight' ? 'selected' : ''}>Return Flight</option>
                        <option ${data.legType === 'Connection Flight' ? 'selected' : ''}>Connection Flight</option>
                        <option ${data.legType === 'Multi-City Flight' ? 'selected' : ''}>Multi-City Flight</option>
                    </select>
                </td>
                <td><input type="text" class="form-control airline" placeholder="Airline (code or name)" value="${data.airline || ''}" oninput="displayAirline(this)" onchange="updateEmailTemplate(); saveState();"><div class="airport-display"></div></td>
                <td><input type="text" class="form-control airport-input departure-airport" placeholder="Dep (IATA)" value="${data.departureAirport || ''}" oninput="displayAirport(this)" onchange="updateEmailTemplate(); saveState();"><div class="airport-display"></div></td>
                <td><input type="text" class="form-control airport-input arrival-airport" placeholder="Arr (IATA)" value="${data.arrivalAirport || ''}" oninput="displayAirport(this)" onchange="updateEmailTemplate(); saveState();"><div class="airport-display"></div></td>
                <td><input type="time" class="form-control dep-time" value="${data.depTime || ''}" onchange="updateEmailTemplate(); saveState();"></td>
                <td><input type="time" class="form-control arr-time" value="${data.arrTime || ''}" onchange="updateEmailTemplate(); saveState();"></td>
                <td>
                    <input type="checkbox" class="baggage-include" onchange="toggleBaggage(this.closest('tr'));"> Include Baggage
                    <div class="baggage-group">
                        <input type="number" class="form-control baggage-number" min="0" value="${data.baggageNumber || 1}" onchange="updateEmailTemplate(); saveState();">
                        <select class="baggage-weight-select baggage-allowance" onchange="updateEmailTemplate(); saveState();">
                            <option ${data.baggageAllowance === '10kg' ? 'selected' : ''}>10kg</option>
                            <option ${data.baggageAllowance === '15kg' ? 'selected' : ''}>15kg</option>
                            <option ${data.baggageAllowance === '20kg' ? 'selected' : ''}>20kg</option>
                            <option ${data.baggageAllowance === '23kg' ? 'selected' : ''}>23kg</option>
                            <option ${data.baggageAllowance === '25kg' ? 'selected' : ''}>25kg</option>
                            <option ${data.baggageAllowance === '30kg' ? 'selected' : ''}>30kg</option>
                        </select>
                        <input type="number" class="form-control baggage-price" step="0.01" placeholder="0.00 (if extra)" value="${data.baggagePrice || ''}" onchange="updateEmailTemplate(); saveState();">
                    </div>
                </td>
                <td><input type="number" class="form-control net-price" step="0.01" placeholder="0.00" value="${data.netPrice || ''}" onchange="updateFlightLegPrice('${id}'); saveState();"></td>
                <td><input type="text" class="form-control commission-rate" placeholder="Use global" value="${data.commissionRate || ''}" onchange="updateFlightLegPrice('${id}'); saveState();"></td>
                <td><input type="text" class="form-control selling-price" readonly placeholder="0.00" value=""></td>
                <td><input type="text" class="form-control commission-amount" readonly placeholder="0.00" value=""></td>
                <td>
                    <select class="form-control cancellation-policy" onchange="toggleCancellationFee('${id}'); updateFlightQuoteTotals('${sectionId}'); updateEmailTemplate(); saveState();">
                        <option value="" selected>-- Select Policy --</option>
                        <option value="non-refundable" ${data.cancellationPolicy === 'non-refundable' ? 'selected' : ''}>Non-Refundable</option>
                        <option value="refundable" ${data.cancellationPolicy === 'refundable' ? 'selected' : ''}>Refundable</option>
                        <option value="refundable-with-fee" ${data.cancellationPolicy === 'refundable-with-fee' ? 'selected' : ''}>Refundable with Fee</option>
                    </select>
                    <div class="cancellation-deadline-group" style="display:none;">
                        <input type="text" class="form-control cancellation-deadline" placeholder="Select cancellation deadline" value="${data.cancellationDeadline || ''}" onchange="updateFlightQuoteTotals('${sectionId}'); updateEmailTemplate(); saveState();">
                    </div>
                    <div class="cancellation-fee-group" style="display:none;">
                        <input type="number" class="form-control cancellation-fee" step="0.01" placeholder="0.00" value="${(data.cancellationFee || 0).toFixed(2)}" onchange="updateFlightQuoteTotals('${sectionId}'); updateEmailTemplate(); saveState();">
                    </div>
                </td>
                <td class="upgrade-cell">
                    <input type="checkbox" id="${id}-upgrade" ${data.upgrade ? 'checked' : ''} onchange="toggleUpgrade('${id}'); updateEmailTemplate(); saveState();">
                    <div class="upgrade-modes" style="display: ${data.upgrade ? 'block' : 'none'};">
                        <label><input type="checkbox" id="${id}-upgrade-auto" ${data.upgradeAuto ? 'checked' : ''} onchange="handleUpgradeMode('${id}', 'auto'); updateEmailTemplate(); saveState();"> Auto-upgrade from base</label>
                        <label><input type="checkbox" id="${id}-upgrade-manual" ${data.upgradeManual ? 'checked' : ''} onchange="handleUpgradeMode('${id}', 'manual'); updateEmailTemplate(); saveState();"> Manual upgrade</label>
                    </div>
                    <div id="${id}-auto-section" style="display: ${data.upgrade && data.upgradeAuto ? 'block' : 'none'}; margin-top: 5px;">
                        <small>Upgrade amount: <span id="${id}-auto-amount" class="auto-upgrade-amount">£0.00</span></small>
                    </div>
                    <div id="${id}-manual-section" style="display: ${data.upgrade && data.upgradeManual ? 'block' : 'none'}; margin-top: 5px;">
                        <input type="text" class="form-control upgrade-desc" placeholder="Upgrade description" value="${data.upgradeDesc || ''}" style="margin-bottom: 5px;" onchange="updateEmailTemplate(); saveState();">
                        <input type="number" class="form-control upgrade-amount" step="0.01" placeholder="0.00" value="${(data.upgradeAmount || 0).toFixed(2)}" onchange="updateEmailTemplate(); saveState();">
                    </div>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeFlightLeg('${id}', '${sectionId}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
            updateFlightLegPrice(id);
            initCancellationPickers(tr);
            toggleCancellationFee(id);
            if (data.upgrade) toggleUpgrade(id);
            if (data.upgradeAuto) {
                document.getElementById(id + '-upgrade-auto').checked = true;
                handleUpgradeMode(id, 'auto');
            }
            if (data.upgradeManual) {
                document.getElementById(id + '-upgrade-manual').checked = true;
                handleUpgradeMode(id, 'manual');
            }
            displayAirport(tr.querySelector('.departure-airport'));
            displayAirport(tr.querySelector('.arrival-airport'));
            displayAirline(tr.querySelector('.airline'));
            toggleBaggage(tr);
            updateFlightQuoteTotals(sectionId);
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

        function removeFlightLeg(id, sectionId) {
            if (confirm('Are you sure you want to remove this flight leg?')) {
                const element = document.getElementById(id);
                if (element) {
                    element.remove();
                    updateFlightQuoteTotals(sectionId);
                    updateTotals();
                    updateEmailTemplate();
                    saveState();
                }
            }
        }

        function removeFlightQuoteSection(sectionId, number) {
            if (confirm('Are you sure you want to remove this flight quote section?')) {
                usedFlightQuoteNumbers.delete(number);
                const section = document.getElementById(sectionId);
                if (section) {
                    section.remove();
                    flightQuoteSections = flightQuoteSections.filter(id => id !== sectionId);
                    updateTotals();
                    updateEmailTemplate();
                    saveState();
                }
            }
        }

        function updateFlightLegPrice(id) {
            const item = document.getElementById(id);
            if (!item) return;
            
            const netPriceInput = item.querySelector('.net-price');
            const commissionRateInput = item.querySelector('.commission-rate');
            const sellingPriceInput = item.querySelector('.selling-price');
            const commissionAmountInput = item.querySelector('.commission-amount');
            
            const netPrice = parseFloat(netPriceInput.value) || 0;
            let commissionRate;
            
            if (commissionRateInput && commissionRateInput.value.trim() !== '') {
                commissionRate = parseCommissionRate(commissionRateInput.value);
                if (commissionRate === null) {
                    commissionRate = parseCommissionRate(document.getElementById('commission-rate').value) || 0;
                }
            } else {
                commissionRate = parseCommissionRate(document.getElementById('commission-rate').value) || 0;
            }
            
            const { commissionAmount, sellingPrice } = calculateCommission(netPrice, commissionRate);
            
            if (sellingPriceInput) sellingPriceInput.value = sellingPrice.toFixed(2);
            if (commissionAmountInput) commissionAmountInput.value = commissionAmount.toFixed(2);
            
            // Update auto upgrade if applicable
            const upgradeCb = document.getElementById(id + '-upgrade');
            if (upgradeCb && upgradeCb.checked) {
                const autoCb = document.getElementById(id + '-upgrade-auto');
                if (autoCb && autoCb.checked) {
                    updateUpgradeAutoAmount(id);
                }
            }
            
            const sectionId = item.closest('.flight-quote-section').id;
            updateFlightQuoteTotals(sectionId);
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

        function updateFlightQuoteTotals(sectionId) {
            let netTotal = 0;
            let sellingExact = 0;
            let sellingRounded = 0;
            let upgradeTotal = 0;
            
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            section.querySelectorAll('.flight-leg-row').forEach(item => {
                const upgradeCb = item.querySelector('input[id$="-upgrade"]');
                const isUpgrade = upgradeCb ? upgradeCb.checked : false;
                
                const netPrice = parseFloat(item.querySelector('.net-price').value) || 0;
                const sellingPrice = parseFloat(item.querySelector('.selling-price').value) || 0;
                const upgradeAmount = parseFloat(item.querySelector('.upgrade-amount').value) || 0;
                const baggagePrice = parseFloat(item.querySelector('.baggage-price').value) || 0;
                
                if (!isUpgrade) {
                    netTotal += netPrice + baggagePrice;
                    sellingExact += sellingPrice;
                    sellingRounded += Math.round(sellingPrice);
                }
                
                upgradeTotal += upgradeAmount;
            });
            
            sellingRounded += Math.round(upgradeTotal);
            
            document.getElementById(`${sectionId}-total-net`).textContent = `£${netTotal.toFixed(2)}`;
            document.getElementById(`${sectionId}-total-selling-exact`).textContent = `£${sellingExact.toFixed(2)}`;
            document.getElementById(`${sectionId}-total-selling-rounded`).textContent = `£${sellingRounded.toFixed(2)}`;
        }

        function toggleBaggage(row) {
            const checkbox = row.querySelector('.baggage-include');
            const group = row.querySelector('.baggage-group');
            if (checkbox.checked) {
                group.classList.add('show');
            } else {
                group.classList.remove('show');
            }
        }

        function toggleCancellationFee(id) {
            const item = document.getElementById(id);
            const policySelect = item.querySelector('.cancellation-policy');
            const feeGroup = item.querySelector('.cancellation-fee-group');
            const deadlineGroup = item.querySelector('.cancellation-deadline-group');
            
            if (!policySelect) return;
            
            const policy = policySelect.value;
            if (policy === '') {
                if (feeGroup) feeGroup.style.display = 'none';
                if (deadlineGroup) deadlineGroup.style.display = 'none';
            } else if (policy === 'refundable-with-fee') {
                if (feeGroup) feeGroup.style.display = 'block';
                if (deadlineGroup) deadlineGroup.style.display = 'block';
            } else if (policy === 'refundable') {
                if (feeGroup) feeGroup.style.display = 'none';
                if (deadlineGroup) deadlineGroup.style.display = 'block';
            } else {
                if (feeGroup) feeGroup.style.display = 'none';
                if (deadlineGroup) deadlineGroup.style.display = 'none';
            }
            initCancellationPickers(item);
            const section = item.closest('.card');
            const sectionId = section.id;
            if (section.classList.contains('hotel-quote-section')) {
                updateQuoteTotals(sectionId);
                calculateBalanceDueDateForSection(sectionId);
            } else if (section.classList.contains('flight-quote-section')) {
                updateFlightQuoteTotals(sectionId);
            }
            saveState();
        }

        function toggleUpgrade(id) {
            const item = document.getElementById(id);
            const modesDiv = item.querySelector('.upgrade-modes');
            const autoSection = document.getElementById(id + '-auto-section');
            const manualSection = document.getElementById(id + '-manual-section');
            const upgradeCb = document.getElementById(id + '-upgrade');
            if (upgradeCb.checked) {
                const choice = prompt("Upgrade type:\n1 - Auto-upgrade from base (link to existing included option)\n2 - Manual custom upgrade");
                if (choice === '1') {
                    document.getElementById(id + '-upgrade-auto').checked = true;
                    document.getElementById(id + '-upgrade-manual').checked = false;
                    handleUpgradeMode(id, 'auto');
                } else if (choice === '2') {
                    document.getElementById(id + '-upgrade-auto').checked = false;
                    document.getElementById(id + '-upgrade-manual').checked = true;
                    handleUpgradeMode(id, 'manual');
                } else {
                    upgradeCb.checked = false;
                    modesDiv.style.display = 'none';
                    if (autoSection) autoSection.style.display = 'none';
                    if (manualSection) manualSection.style.display = 'none';
                    return;
                }
                modesDiv.style.display = 'block';
            } else {
                modesDiv.style.display = 'none';
                if (autoSection) autoSection.style.display = 'none';
                if (manualSection) manualSection.style.display = 'none';
            }
            const section = item.closest('.card');
            if (section && !section.classList.contains('flight-quote-section')) {
                updateQuoteTotals(section.id);
            } else {
                updateFlightQuoteTotals(section.id);
            }
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

        function handleUpgradeMode(id, mode) {
            const item = document.getElementById(id);
            const autoCb = document.getElementById(id + '-upgrade-auto');
            const manualCb = document.getElementById(id + '-upgrade-manual');
            const autoSection = document.getElementById(id + '-auto-section');
            const manualSection = document.getElementById(id + '-manual-section');
            const amtInput = item.querySelector('.upgrade-amount');
            if (mode === 'auto') {
                manualCb.checked = false;
                autoSection.style.display = 'block';
                manualSection.style.display = 'none';
                if (amtInput) {
                    amtInput.readOnly = true;
                }
                updateUpgradeAutoAmount(id);
            } else {
                autoCb.checked = false;
                autoSection.style.display = 'none';
                manualSection.style.display = 'block';
                if (amtInput) {
                    amtInput.readOnly = false;
                }
            }
            updateEmailTemplate();
            saveState();
        }

        function updateUpgradeAutoAmount(id) {
            const item = document.getElementById(id);
            let section;
            if (item.closest('.hotel-quote-section')) {
                section = item.closest('.hotel-quote-section');
            } else if (item.closest('.flight-quote-section')) {
                section = item.closest('.flight-quote-section');
            } else {
                return;
            }
            let basePrice = Infinity;
            if (section.classList.contains('hotel-quote-section')) {
                const roomIndex = parseInt(item.getAttribute('data-room') || '0');
                const compId = `${section.id}-room-${roomIndex}-comparison`;
                const comparison = document.getElementById(compId);
                if (comparison) {
                    const rows = comparison.querySelectorAll('.supplier-table-row');
                    rows.forEach(row => {
                        if (row.id === id) return;
                        const incCb = row.querySelector('input[id$="-include-email"]');
                        const upCb = row.querySelector('input[id$="-upgrade"]');
                        if (incCb && incCb.checked && !(upCb && upCb.checked)) {
                            const sell = parseFloat(row.querySelector('.selling-price').value) || Infinity;
                            if (sell < basePrice) basePrice = sell;
                        }
                    });
                }
            } else {
                const rows = section.querySelectorAll('.flight-leg-row');
                rows.forEach(row => {
                    if (row.id === id) return;
                    const upCb = row.querySelector('input[id$="-upgrade"]');
                    if (!(upCb && upCb.checked)) {
                        const sell = parseFloat(row.querySelector('.selling-price').value) || Infinity;
                        if (sell < basePrice) basePrice = sell;
                    }
                });
            }
            const thisSell = parseFloat(item.querySelector('.selling-price').value) || 0;
            let diff = 0;
            if (basePrice !== Infinity) {
                diff = Math.round(thisSell - basePrice);
                if (diff < 0) diff = 0;
            }
            const amtInput = item.querySelector('.upgrade-amount');
            if (amtInput) {
                amtInput.value = diff.toFixed(2);
            }
            const span = document.getElementById(id + '-auto-amount');
            if (span) {
                span.textContent = '£' + diff.toFixed(2);
            }
        }

        function updateSupplierPrice(id) {
            const item = document.getElementById(id);
            if (!item) return;
            
            const netPriceInput = item.querySelector('.net-price');
            const commissionRateInput = item.querySelector('.commission-rate');
            const sellingPriceInput = item.querySelector('.selling-price');
            const commissionAmountInput = item.querySelector('.commission-amount');
            const calculationDiv = item.querySelector('.commission-calculation');
            
            const netPrice = parseFloat(netPriceInput.value) || 0;
            let commissionRate;
            
            if (commissionRateInput && commissionRateInput.value.trim() !== '') {
                commissionRate = parseCommissionRate(commissionRateInput.value);
                if (commissionRate === null) {
                    commissionRate = parseCommissionRate(document.getElementById('commission-rate').value) || 0;
                }
            } else {
                commissionRate = parseCommissionRate(document.getElementById('commission-rate').value) || 0;
            }
            
            const { commissionAmount, sellingPrice } = calculateCommission(netPrice, commissionRate);
            
            if (sellingPriceInput) sellingPriceInput.value = sellingPrice.toFixed(2);
            if (commissionAmountInput) commissionAmountInput.value = commissionAmount.toFixed(2);
            
            if (calculationDiv) {
                const divisor = (1 - commissionRate).toFixed(3);
                calculationDiv.textContent = `${netPrice.toFixed(2)} / ${divisor} = ${sellingPrice.toFixed(2)}`;
            }
            
            // Update auto upgrade if applicable
            const upgradeCb = document.getElementById(id + '-upgrade');
            if (upgradeCb && upgradeCb.checked) {
                const autoCb = document.getElementById(id + '-upgrade-auto');
                if (autoCb && autoCb.checked) {
                    updateUpgradeAutoAmount(id);
                }
            }
            
            const section = item.closest('.card');
            const sectionId = section.id;
            if (sectionId && !section.classList.contains('flight-quote-section')) {
                const numRooms = roomsData.length;
                for (let i = 0; i < numRooms; i++) {
                    autoSelectBestForComparison(`${sectionId}-room-${i}-comparison`);
                }
                updateQuoteTotals(sectionId);
            } else {
                updateFlightQuoteTotals(sectionId);
            }
            updateTotals();
            updateEmailTemplate();
            saveState();
        }

        function updateQuoteTotals(sectionId) {
            let netTotal = 0;
            let sellingExact = 0;
            let sellingRounded = 0;
            let upgradeTotal = 0;
            
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            section.querySelectorAll('.supplier-table-row').forEach(item => {
                const includeEmail = item.querySelector('input[id$="-include-email"]')?.checked || false;
                const isUpgrade = item.querySelector('input[type="checkbox"][id$="-upgrade"]')?.checked || false;
                
                const netPrice = parseFloat(item.querySelector('.net-price').value) || 0;
                const sellingPrice = parseFloat(item.querySelector('.selling-price').value) || 0;
                const upgradeAmount = parseFloat(item.querySelector('.upgrade-amount').value) || 0;
                const rooms = parseInt(item.querySelector('.rooms').value) || 1;
                
                if (!isUpgrade && includeEmail) {
                    netTotal += netPrice * rooms;
                    sellingExact += sellingPrice * rooms;
                    sellingRounded += Math.round(sellingPrice * rooms);
                }
                
                if (includeEmail || isUpgrade) {
                    upgradeTotal += upgradeAmount * rooms;
                }
            });
            
            // Add upgrades to rounded total
            sellingRounded += Math.round(upgradeTotal);
            
            document.getElementById(`${sectionId}-total-net`).textContent = `£${netTotal.toFixed(2)}`;
            document.getElementById(`${sectionId}-total-selling-exact`).textContent = `£${sellingExact.toFixed(2)}`;
            document.getElementById(`${sectionId}-total-selling-rounded`).textContent = `£${sellingRounded.toFixed(2)}`;
        }

        function updateTotals() {
            let hotelNetTotal = 0;
            let hotelSellingExact = 0;
            let hotelSellingRounded = 0;
            
            // Collect from checked hotel quote sections
            hotelQuoteSections.forEach(sectionId => {
                const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                if (!checkbox || !checkbox.checked) return;
                
                const netEl = document.getElementById(`${sectionId}-total-net`);
                const exactEl = document.getElementById(`${sectionId}-total-selling-exact`);
                const roundedEl = document.getElementById(`${sectionId}-total-selling-rounded`);
                
                if (netEl && exactEl && roundedEl) {
                    hotelNetTotal += parseFloat(netEl.textContent.replace('£', '')) || 0;
                    hotelSellingExact += parseFloat(exactEl.textContent.replace('£', '')) || 0;
                    hotelSellingRounded += parseFloat(roundedEl.textContent.replace('£', '')) || 0;
                }
            });
            
            let flightNetTotal = 0;
            let flightSellingExact = 0;
            let flightSellingRounded = 0;
            
            // Collect from checked flight quote sections
            flightQuoteSections.forEach(sectionId => {
                const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                if (!checkbox || !checkbox.checked) return;
                
                const netEl = document.getElementById(`${sectionId}-total-net`);
                const exactEl = document.getElementById(`${sectionId}-total-selling-exact`);
                const roundedEl = document.getElementById(`${sectionId}-total-selling-rounded`);
                
                if (netEl && exactEl && roundedEl) {
                    flightNetTotal += parseFloat(netEl.textContent.replace('£', '')) || 0;
                    flightSellingExact += parseFloat(exactEl.textContent.replace('£', '')) || 0;
                    flightSellingRounded += parseFloat(roundedEl.textContent.replace('£', '')) || 0;
                }
            });
            
            let optionalExtrasTotal = 0;
            const numRooms = parseInt(document.getElementById('rooms-count').textContent);
            document.querySelectorAll('#optional-extras-list .optional-extra-item input[type="checkbox"]:checked').forEach(cb => {
                const item = cb.closest('.optional-extra-item');
                const cost = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                optionalExtrasTotal += Math.round(cost * numRooms);
            });
            
            const totalNet = hotelNetTotal + flightNetTotal;
            const totalSellingExact = hotelSellingExact + flightSellingExact;
            const totalSellingRounded = hotelSellingRounded + flightSellingRounded + optionalExtrasTotal;
            
            // Build breakdown HTML
            const totalsPanel = document.getElementById('totals-breakdown');
            let html = '';
            const bookingType = document.getElementById('booking-type').value;
            const pricePerRoute = document.getElementById('price-per-route').checked;
            
            if (bookingType === 'hotel' || bookingType === 'package') {
                // Hotel breakdowns
                hotelQuoteSections.forEach(sectionId => {
                    const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    html += `<div class="totals-subsection"><h4>Hotel Quote ${sectionId.split('-')[2]}</h4>`;
                    
                    const numRooms = roomsData.length;
                    for (let room = 0; room < numRooms; room++) {
                        const compId = `${sectionId}-room-${room}-comparison`;
                        const includedRow = document.querySelector(`#${compId} .supplier-table-row input[id$="-include-email"]:checked`)?.closest('.supplier-table-row');
                        if (includedRow) {
                            const selling = parseFloat(includedRow.querySelector('.selling-price').value) || 0;
                            const roomsInSup = parseInt(includedRow.querySelector('.rooms').value) || 1;
                            const supName = includedRow.querySelector('.supplier-name').value;
                            html += `<div class="totals-row"><span class="totals-label">Room ${room + 1} (${supName}):</span><span class="totals-value">£${(selling * roomsInSup).toFixed(2)}</span></div>`;
                        }
                    }
                    
                    const hotelNet = parseFloat(document.getElementById(`${sectionId}-total-net`).textContent.replace('£', '')) || 0;
                    const hotelSellExact = parseFloat(document.getElementById(`${sectionId}-total-selling-exact`).textContent.replace('£', '')) || 0;
                    const hotelSellRounded = parseFloat(document.getElementById(`${sectionId}-total-selling-rounded`).textContent.replace('£', '')) || 0;
                    
                    html += `<div class="totals-row"><span class="totals-label">Hotel Net Total:</span><span class="totals-value">£${hotelNet.toFixed(2)}</span></div>`;
                    html += `<div class="totals-row"><span class="totals-label">Hotel Selling Exact:</span><span class="totals-value">£${hotelSellExact.toFixed(2)}</span></div>`;
                    html += `<div class="totals-row"><span class="totals-label">Hotel Selling Rounded:</span><span class="totals-value">£${hotelSellRounded.toFixed(2)}</span></div></div>`;
                });
            }
            
            if (bookingType === 'package') {
                // Flight breakdowns
                flightQuoteSections.forEach(sectionId => {
                    const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    html += `<div class="totals-subsection"><h4>Flight Quote ${sectionId.split('-')[2]}</h4>`;
                    
                    if (pricePerRoute) {
                        let departureTotal = 0;
                        let returnTotal = 0;
                        let multiTotal = 0;
                        
                        document.querySelectorAll(`#${sectionId} .flight-leg-row`).forEach(row => {
                            const legType = row.querySelector('.leg-type').value;
                            const selling = parseFloat(row.querySelector('.selling-price').value) || 0;
                            const upgradeAmt = parseFloat(row.querySelector('.upgrade-amount').value) || 0;
                            const totalLeg = selling + upgradeAmt;
                            const airline = row.querySelector('.airline').value;
                            const dep = row.querySelector('.departure-airport').value;
                            const arr = row.querySelector('.arrival-airport').value;
                            const route = dep + '-' + arr;
                            
                            html += `<div class="totals-row"><span class="totals-label">${legType} ${route} (${airline}):</span><span class="totals-value">£${totalLeg.toFixed(2)}</span></div>`;
                            
                            if (legType === 'Departure Flight') {
                                departureTotal += totalLeg;
                            } else if (legType === 'Return Flight') {
                                returnTotal += totalLeg;
                            } else {
                                multiTotal += totalLeg;
                            }
                        });
                        
                        if (departureTotal > 0) {
                            html += `<div class="totals-row"><span class="totals-label">Departure Total:</span><span class="totals-value">£${departureTotal.toFixed(2)}</span></div>`;
                        }
                        if (returnTotal > 0) {
                            html += `<div class="totals-row"><span class="totals-label">Return Total:</span><span class="totals-value">£${returnTotal.toFixed(2)}</span></div>`;
                        }
                        if (multiTotal > 0) {
                            html += `<div class="totals-row"><span class="totals-label">Multi-City Total:</span><span class="totals-value">£${multiTotal.toFixed(2)}</span></div>`;
                        }
                    } else {
                        const flightNet = parseFloat(document.getElementById(`${sectionId}-total-net`).textContent.replace('£', '')) || 0;
                        const flightSellExact = parseFloat(document.getElementById(`${sectionId}-total-selling-exact`).textContent.replace('£', '')) || 0;
                        const flightSellRounded = parseFloat(document.getElementById(`${sectionId}-total-selling-rounded`).textContent.replace('£', '')) || 0;
                        
                        html += `<div class="totals-row"><span class="totals-label">Flight Net Total:</span><span class="totals-value">£${flightNet.toFixed(2)}</span></div>`;
                        html += `<div class="totals-row"><span class="totals-label">Flight Selling Exact:</span><span class="totals-value">£${flightSellExact.toFixed(2)}</span></div>`;
                        html += `<div class="totals-row"><span class="totals-label">Flight Selling Rounded:</span><span class="totals-value">£${flightSellRounded.toFixed(2)}</span></div>`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            // Optional extras
            document.querySelectorAll('#optional-extras-list .optional-extra-item input[type="checkbox"]:checked').forEach(cb => {
                const item = cb.closest('.optional-extra-item');
                const cost = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                const extraTotal = Math.round(cost * numRooms);
                const name = item.querySelector('input[type="text"]').value;
                html += `<div class="totals-row"><span class="totals-label">${name}:</span><span class="totals-value">£${extraTotal.toFixed(2)}</span></div>`;
            });
            
            // Grand totals
            const grandPrefix = bookingType === 'package' ? 'Package ' : 'Grand ';
            html += `
                <div class="totals-row grand-total">
                    <span class="totals-label">${grandPrefix}Total Net:</span>
                    <span class="totals-value">£${totalNet.toFixed(2)}</span>
                </div>
                <div class="totals-row grand-total">
                    <span class="totals-label">${grandPrefix}Total Selling (exact):</span>
                    <span class="totals-value">£${totalSellingExact.toFixed(2)}</span>
                </div>
                <div class="totals-row grand-total">
                    <span class="totals-label">${grandPrefix}Total Selling (rounded):</span>
                    <span class="totals-value">£${totalSellingRounded.toFixed(2)}</span>
                </div>
            `;
            
            totalsPanel.innerHTML = html;
        }

        function displayAirport(input) {
            const displayDiv = input.nextElementSibling;
            const code = input.value.toUpperCase().trim();
            
            if (code.length >= 3 && AIRPORTS[code]) {
                displayDiv.textContent = AIRPORTS[code];
                displayDiv.style.display = 'block';
            } else {
                displayDiv.textContent = '';
                displayDiv.style.display = 'none';
            }
        }

        function displayAirline(input) {
            const displayDiv = input.nextElementSibling;
            const code = input.value.toUpperCase().trim();
            
            if (code.length >= 2 && AIRLINES[code]) {
                displayDiv.textContent = AIRLINES[code];
                displayDiv.style.display = 'block';
            } else {
                displayDiv.textContent = '';
                displayDiv.style.display = 'none';
            }
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'Pay Now') return dateString;
            const date = new Date(dateString);
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const day = date.getDate().toString().padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            return `${day}${month}${year}`;
        }

        function formatDateRange(startDate, endDate) {
            if (!startDate || !endDate) return '';
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }

        function getChildAgesList() {
            let allAges = [];
            roomsData.forEach(room => {
                allAges = allAges.concat(room.childAges.filter(age => age));
            });
            return allAges;
        }

        function boldWrap(text) {
            if (currentDeliveryOption === 'whatsapp') {
                return `*${text}*`;
            } else {
                return `<b>${text}</b>`;
            }
        }

        function isAllNonRefundable(type) {
            let items;
            if (type === 'hotel') {
                items = [];
                hotelQuoteSections.forEach(sectionId => {
                    const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                    if (!checkbox || !checkbox.checked) return;
                    items.push(...Array.from(document.querySelectorAll(`#${sectionId} .supplier-table-row input[id$="-include-email"]:checked`)).map(cb => cb.closest('.supplier-table-row')));
                });
            } else {
                items = [];
                flightQuoteSections.forEach(sectionId => {
                    const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                    if (!checkbox || !checkbox.checked) return;
                    items.push(...Array.from(document.querySelectorAll(`#${sectionId} .flight-leg-row`)).map(row => row));
                });
            }
            if (items.length === 0) return false;
            return items.every(item => {
                const policy = item.querySelector('.cancellation-policy').value;
                return policy === 'non-refundable';
            });
        }

function updateEmailTemplate() {
    if (isEditing) return;
    const bookingType = document.getElementById('booking-type').value;
    const customerName = document.getElementById('customer-name').value || '[Customer Name]';
    let agentName = document.getElementById('agent-name').value;
    if (agentName === 'custom') {
        agentName = document.getElementById('custom-agent-name').value || '[Agent Name]';
    }
    const agentEmail = document.getElementById('agent-email').value;
    const agentPhone = document.getElementById('agent-phone').value;
    const quoteReference = document.getElementById('quote-reference').value || '[quote_reference]';
    
    const depositAmount = '25';
    
    const travelers = getTotalTravelers();
    const adults = travelers.adults;
    const children = travelers.children;
    const childAges = getChildAgesList();
    
    // Find first checked hotel quote for excludes and balance
    let firstCheckedSectionId = null;
    hotelQuoteSections.forEach(sectionId => {
        const checkbox = document.querySelector(`#${sectionId} .quote-include`);
        if (checkbox && checkbox.checked && !firstCheckedSectionId) {
            firstCheckedSectionId = sectionId;
        }
    });
    const excludesCurrency = firstCheckedSectionId ? document.getElementById(`${firstCheckedSectionId}-excludes-currency`).value : '';
    const excludesAmount = firstCheckedSectionId ? document.getElementById(`${firstCheckedSectionId}-excludes-amount`).value : '';
    const excludesNote = excludesCurrency && excludesAmount ? `Local taxes ${excludesCurrency} ${excludesAmount} per night, payable locally` : '';
    const balanceDueInput = firstCheckedSectionId ? document.getElementById(firstCheckedSectionId).getAttribute('data-balance-due') || '' : '';
    
    let balanceDueDate;
    if (balanceDueInput === 'Pay Now') {
        balanceDueDate = 'Pay Now';
    } else if (balanceDueInput) {
        balanceDueDate = formatDate(balanceDueInput);
    } else {
        balanceDueDate = '[balance_due_date]';
    }
    
    const flightDatesInput = document.getElementById('flight-dates').value;
    let departDate = '', returnDate = '';
    if (flightDatesInput) {
        const dates = flightDatesInput.split(' to ');
        departDate = dates[0] ? formatDate(dates[0]) : '';
        returnDate = dates[1] ? formatDate(dates[1]) : '';
    }
    
    // Collect checked hotel quotes
    let checkedHotelQuotes = [];
    let hotelUpgrades = []; // Collect upgrades separately
    const numRooms = parseInt(document.getElementById('rooms-count').textContent);
    const pricePerRoom = document.getElementById('price-per-room').checked;
    const priceSuffix = pricePerRoom ? ' per room' : '';
    if (bookingType === 'hotel' || bookingType === 'package') {
        hotelQuoteSections.forEach(sectionId => {
            const checkbox = document.querySelector(`#${sectionId} .quote-include`);
            if (!checkbox || !checkbox.checked) return;
            
            const section = document.getElementById(sectionId);
            const hotelNameInput = document.getElementById(`${sectionId}-hotel-name`);
            const destinationInput = document.getElementById(`${sectionId}-destination`);
            const hotelName = hotelNameInput ? hotelNameInput.value.trim() : '';
            const destination = destinationInput ? destinationInput.value.trim() : '';
            const checkinInput = section.querySelector('.hotel-checkin');
            const nightsInput = section.querySelector('.hotel-nights');
            const checkin = checkinInput ? checkinInput.value : '';
            const nights = nightsInput ? nightsInput.value : '0';
            
            let startDate = '', endDate = '';
            if (checkin) {
                const dates = checkin.split(' to ');
                startDate = dates[0] ? formatDate(dates[0]) : '';
                endDate = dates[1] ? formatDate(dates[1]) : '';
            }
            
            let includedSuppliers = [];
            let upgradeRows = []; // Upgrade rows
            
            section.querySelectorAll('.supplier-table-row').forEach(item => {
                const includeInEmail = item.querySelector('input[id$="-include-email"]');
                const upgradeCheckbox = item.querySelector('input[id$="-upgrade"]');
                const isUpgrade = upgradeCheckbox && upgradeCheckbox.checked;
                const includeEmailChecked = includeInEmail && includeInEmail.checked;
                const shouldInclude = includeEmailChecked || isUpgrade; // Include if either

                if (shouldInclude) {
                    const roomTypeInput = item.querySelector('.room-type');
                    const roomsInput = item.querySelector('.rooms');
                    const boardBasisInput = item.querySelector('.board-basis');
                    const cancelPolicySelect = item.querySelector('.cancellation-policy');
                    const cancelFeeInput = item.querySelector('.cancellation-fee');
                    const deadlineInput = item.querySelector('.cancellation-deadline');
                    const upgradeDescInput = item.querySelector('.upgrade-desc');
                    const upgradeAmountInput = item.querySelector('.upgrade-amount');
                    const supplierNameInput = item.querySelector('.supplier-name');
                    
                    const roomType = roomTypeInput ? roomTypeInput.value || '[Room Type]' : '[Room Type]';
                    const rooms = parseInt(roomsInput ? roomsInput.value : '1') || 1;
                    const boardBasis = boardBasisInput ? boardBasisInput.value || '[Board Basis]' : '[Board Basis]';
                    const upgradeDesc = upgradeDescInput ? upgradeDescInput.value : '';
                    let upgradeAmount = parseFloat(upgradeAmountInput ? upgradeAmountInput.value : '0') || 0;
                    let supplierName = supplierNameInput ? supplierNameInput.value.trim() : '';
                    
                    // Strip any appended room/occupancy from supplier name for clean display
                    const cleanSupplierName = supplierName.replace(/ Room \d+ \([^)]*\)$/, '').trim();
                    
                    const cancelPolicy = cancelPolicySelect ? cancelPolicySelect.value : '';
                    const cancelFee = parseFloat(cancelFeeInput ? cancelFeeInput.value || '0.00' : '0.00') || 0;
                    const deadline = deadlineInput ? deadlineInput.value || '' : '';
                    const cancelText = getCancellationText(cancelPolicy, cancelFee, deadline);
                    
                    const sellingPrice = parseFloat(item.querySelector('.selling-price').value) || 0;
                    const roomIndex = parseInt(item.getAttribute('data-room') || '0');

                    if (!isUpgrade && includeEmailChecked) {
                        // Base option
                        let detailText = `${rooms} x ${roomType} on ${boardBasis}\n`;
                        const optionPrice = Math.round(sellingPrice * rooms);
                        includedSuppliers.push({
                            detailText,
                            price: optionPrice,
                            cancelText,
                            roomIndex,
                            supplierName: cleanSupplierName
                        });
                    }

                    if (isUpgrade) {
                        // Upgrade row
                        let baseSellingPrice = Infinity;
                        // ... (keep existing logic for upgrade amount calculation)
                        if (upgradeDesc && upgradeAmount === 0) {
                            // If desc filled but amount 0, use manual
                            upgradeAmount = 0;
                        } else if (!upgradeDesc && baseSellingPrice < Infinity) {
                            // No desc, auto calculate diff
                            upgradeAmount = Math.round(sellingPrice - baseSellingPrice);
                            upgradeAmountInput.value = upgradeAmount.toFixed(2); // Update UI
                        }
                        let upgradeText = upgradeDesc || `${rooms} x ${roomType}, ${boardBasis}`;
                        upgradeRows.push({ upgradeDesc: upgradeText, upgradeAmount: upgradeAmount * rooms, roomType, rooms, boardBasis, sellingPrice });
                    }
                }
            });

            checkedHotelQuotes.push({
                hotelName,
                destination,
                startDate,
                endDate,
                nights,
                includedSuppliers,
                upgrades: upgradeRows
            });

            // Collect global hotel upgrades
            upgradeRows.forEach(upgrade => {
                let upgradeText = upgrade.upgradeDesc || `${upgrade.rooms} x ${upgrade.roomType}, ${upgrade.boardBasis}`;
                hotelUpgrades.push(`Upgrade to ${boldWrap(upgradeText)} add ${boldWrap('£' + Math.round(upgrade.upgradeAmount).toFixed(0))}`);
            });
        });
    }
    
    let checkedFlightQuotes = [];
    let flightUpgrades = [];
    if (bookingType === 'package') {
        flightQuoteSections.forEach(sectionId => {
            const checkbox = document.querySelector(`#${sectionId} .quote-include`);
            if (!checkbox || !checkbox.checked) return;
            
            const section = document.getElementById(sectionId);
            
            let legs = [];
            let upgradeRows = [];
            
            section.querySelectorAll('.flight-leg-row').forEach(item => {
                const upgradeCheckbox = item.querySelector('input[id$="-upgrade"]');
                const isUpgrade = upgradeCheckbox && upgradeCheckbox.checked;
                
                const legTypeSelect = item.querySelector('.leg-type');
                const airlineInput = item.querySelector('.airline');
                const depAirportInput = item.querySelector('.departure-airport');
                const arrAirportInput = item.querySelector('.arrival-airport');
                const depTimeInput = item.querySelector('.dep-time');
                const arrTimeInput = item.querySelector('.arr-time');
                const baggageCheckbox = item.querySelector('.baggage-include');
                const baggageNumberInput = item.querySelector('.baggage-number');
                const baggageSelect = item.querySelector('.baggage-allowance');
                const baggagePriceInput = item.querySelector('.baggage-price');
                const upgradeDescInput = item.querySelector('.upgrade-desc');
                const upgradeAmountInput = item.querySelector('.upgrade-amount');
                const cancelPolicySelect = item.querySelector('.cancellation-policy');
                const cancelFeeInput = item.querySelector('.cancellation-fee');
                const deadlineInput = item.querySelector('.cancellation-deadline');
                
                const legType = legTypeSelect ? legTypeSelect.value : '';
                const airline = airlineInput ? airlineInput.value || '[Airline]' : '[Airline]';
                const depAirport = depAirportInput ? depAirportInput.value.toUpperCase() : '';
                const arrAirport = arrAirportInput ? arrAirportInput.value.toUpperCase() : '';
                const depTime = depTimeInput ? depTimeInput.value.replace(':', '') : '';
                const arrTime = arrTimeInput ? arrTimeInput.value.replace(':', '') : '';
                const includeBaggage = baggageCheckbox ? baggageCheckbox.checked : false;
                const baggageNumber = parseInt(baggageNumberInput ? baggageNumberInput.value : '1') || 1;
                const baggageAllowance = baggageSelect ? baggageSelect.value : '';
                const baggagePrice = parseFloat(baggagePriceInput ? baggagePriceInput.value : '0') || 0;
                const upgradeDesc = upgradeDescInput ? upgradeDescInput.value : '';
                let upgradeAmount = parseFloat(upgradeAmountInput ? upgradeAmountInput.value : '0') || 0;
                const sellingPrice = parseFloat(item.querySelector('.selling-price').value) || 0;
                
                const cancelPolicy = cancelPolicySelect ? cancelPolicySelect.value : '';
                const cancelFee = parseFloat(cancelFeeInput ? cancelFeeInput.value || '0.00' : '0.00') || 0;
                const deadline = deadlineInput ? deadlineInput.value || '' : '';
                const cancelText = getCancellationText(cancelPolicy, cancelFee, deadline);
                
                if (isUpgrade) {
                    let baseSellingPrice = Infinity;
                    const rows = section.querySelectorAll('.flight-leg-row');
                    rows.forEach(row => {
                        if (row.id === id) return;
                        const upCb = row.querySelector('input[id$="-upgrade"]');
                        if (!(upCb && upCb.checked)) {
                            const sell = parseFloat(row.querySelector('.selling-price').value) || Infinity;
                            if (sell < baseSellingPrice) baseSellingPrice = sell;
                        }
                    });
                    if (upgradeDesc && upgradeAmount === 0) {
                        upgradeAmount = 0;
                    } else if (!upgradeDesc && baseSellingPrice < Infinity) {
                        upgradeAmount = Math.round(sellingPrice - baseSellingPrice);
                        upgradeAmountInput.value = upgradeAmount.toFixed(2);
                    }
                    let upgradeText = upgradeDesc || `${legType} ${depAirport}-${arrAirport}`;
                    upgradeRows.push({ upgradeDesc: upgradeText, upgradeAmount, legType, airline, depAirport, arrAirport });
                } else {
                    let baggageText = '';
                    if (includeBaggage && baggageAllowance) {
                        baggageText = `${baggageNumber} x ${baggageAllowance}${baggagePrice > 0 ? ` (£${Math.round(baggagePrice)})` : ' (included)'}`;
                    }
                    legs.push({
                        legType,
                        airline,
                        depAirport,
                        arrAirport,
                        depTime,
                        arrTime,
                        baggageText,
                        sellingPrice,
                        cancelText
                    });
                }
            });
            
            const totalSelling = legs.reduce((sum, leg) => sum + leg.sellingPrice, 0);
            
            checkedFlightQuotes.push({
                legs,
                totalSelling
            });
            
            // Collect flight upgrades
            upgradeRows.forEach(upgrade => {
                let upgradeText = upgrade.upgradeDesc || `${upgrade.legType} ${upgrade.depAirport} to ${upgrade.arrAirport}, ${upgrade.airline}`;
                flightUpgrades.push(`Upgrade to ${boldWrap(upgradeText)} add ${boldWrap('£' + Math.round(upgrade.upgradeAmount).toFixed(0))}`);
            });
        });
    }
    
    // Collect user optional extras (always, for all types)
    let optionalExtrasText = '';
    document.querySelectorAll('#optional-extras-list .optional-extra-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const nameInput = item.querySelector('input[type="text"]');
            const costInput = item.querySelector('input[type="number"]');
            const name = nameInput ? nameInput.value : '';
            const cost = parseFloat(costInput ? costInput.value : '0') || 0;
            if (name && cost > 0) {
                optionalExtrasText += `${boldWrap(name)} ${boldWrap('£' + Math.round(cost * numRooms).toFixed(0))}${pricePerRoom ? ' per room' : ''}\n`;
            }
        }
    });

    // Append upgrades to optionalExtrasText
    hotelUpgrades.forEach(upgrade => {
        optionalExtrasText += upgrade + (pricePerRoom ? ' per room' : '') + '\n';
    });
    flightUpgrades.forEach(upgrade => {
        optionalExtrasText += upgrade + (pricePerRoom ? ' per room' : '') + '\n';
    });
    
    let templateParts = [];
    
    let websiteUrl = 'bradleytravelstore.com';
    if (agentName !== 'custom') {
        const details = agentDetails[agentName];
        if (details && details.website) {
            websiteUrl = details.website;
        }
    }
    
    let travelerText = `${adults} Adult${adults > 1 ? 's' : ''}`;
    if (children > 0) {
        const agesList = childAges.join(', ');
        travelerText += ` & ${children} Child${children > 1 ? 'ren' : ''}${agesList.length > 0 ? ', ' + agesList : ''}`;
    }
    if (travelers.infants > 0) {
        travelerText += ` & ${travelers.infants} Infant${travelers.infants > 1 ? 's' : ''}`;
    }
    
    if (bookingType === 'hotel') {
        templateParts.push(`Dear ${customerName},`);
        templateParts.push('');
        templateParts.push(`We can offer for ${travelerText}`);
        templateParts.push('');
        if (checkedHotelQuotes.length > 1) {
            checkedHotelQuotes.forEach((quote, index) => {
                templateParts.push(`${boldWrap('OPTION ' + (index + 1))}`);
                templateParts.push('');
                if (quote.hotelName) {
                    templateParts.push(`${boldWrap(quote.hotelName.toUpperCase() + ', ' + quote.destination.toUpperCase())}`);
                }
                templateParts.push(`${formatDateRange(quote.startDate, quote.endDate)} - ${quote.nights} Night${quote.nights > 1 ? 's' : ''}`);
                templateParts.push('');
                if (quote.includedSuppliers.length > 0) {
                    if (numRooms > 1) {
                        quote.includedSuppliers.forEach((sup, idx) => {
                            templateParts.push(`${boldWrap(`Room Option ${idx + 1}`)}`);
                            templateParts.push(sup.detailText);
                            const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                            templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                            if (sup.cancelText) {
                                templateParts.push(`${boldWrap(sup.cancelText)}`);
                            }
                            templateParts.push('');
                        });
                    } else {
                        const sup = quote.includedSuppliers[0];
                        templateParts.push(sup.detailText);
                        const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                        templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                        if (sup.cancelText) {
                            templateParts.push(`${boldWrap(sup.cancelText)}`);
                        }
                        templateParts.push('');
                    }
                }
                if (excludesNote) {
                    templateParts.push(`${excludesNote}\n`);
                }
                templateParts.push('');
            });
        } else if (checkedHotelQuotes.length === 1) {
            const quote = checkedHotelQuotes[0];
            if (quote.hotelName) {
                templateParts.push(`${boldWrap(quote.hotelName.toUpperCase() + ', ' + quote.destination.toUpperCase())}`);
            }
            templateParts.push(`${formatDateRange(quote.startDate, quote.endDate)} - ${quote.nights} Night${quote.nights > 1 ? 's' : ''}`);
            templateParts.push('');
            if (quote.includedSuppliers.length > 0) {
                if (numRooms > 1) {
                    quote.includedSuppliers.forEach((sup, idx) => {
                        templateParts.push(`${boldWrap(`Room Option ${idx + 1}`)}`);
                        templateParts.push(sup.detailText);
                        const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                        templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                        if (sup.cancelText) {
                            templateParts.push(`${boldWrap(sup.cancelText)}`);
                        }
                        templateParts.push('');
                    });
                } else {
                    const sup = quote.includedSuppliers[0];
                    templateParts.push(sup.detailText);
                    const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                    templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                    if (sup.cancelText) {
                        templateParts.push(`${boldWrap(sup.cancelText)}`);
                    }
                    templateParts.push('');
                }
            }
            if (excludesNote) {
                templateParts.push(`${excludesNote}\n`);
            }
            templateParts.push('');
        }
        if (optionalExtrasText) {
            templateParts.push(`${boldWrap('Optional Extras:')}`);
            templateParts.push(optionalExtrasText);
            templateParts.push('');
        }
        if (isHotelRefundable()) {
            templateParts.push(`${boldWrap('Deposit')} ${boldWrap('£25 pp')}`);
        }
        if (balanceDueDate !== '[balance_due_date]' && balanceDueDate !== '' && balanceDueDate !== 'Pay Now') {
            templateParts.push(`${boldWrap('Balance due by')} ${balanceDueDate}`);
        }
        templateParts.push('');
        templateParts.push(`${boldWrap('Includes 5GB eSim Promo')}`);
        templateParts.push('');
        templateParts.push('Prices are live and subject to change prior to confirmation.');
        templateParts.push('');
        templateParts.push(`Kind regards`);
        templateParts.push(`${agentName}`);
        templateParts.push('');
        templateParts.push('Bradley Travelstore');
        templateParts.push(`T: ${agentPhone}`);
        templateParts.push(`E: ${agentEmail}`);
        templateParts.push(`W: ${websiteUrl}`);
        templateParts.push('');
        templateParts.push('We are fully ATOL bonded for your peace of mind.');
        templateParts.push('');
        templateParts.push(`Your Quote Reference #${quoteReference}`);
    } else {
        templateParts.push(`Dear ${customerName},`);
        templateParts.push('');
        templateParts.push(`We can offer for ${travelerText}.`);
        templateParts.push('');
        if (checkedFlightQuotes.length > 1) {
            checkedFlightQuotes.forEach((quote, index) => {
                templateParts.push(`${boldWrap('FLIGHT OPTION ' + (index + 1))}`);
                templateParts.push('');
                templateParts.push('');
                quote.legs.forEach(leg => {
                    templateParts.push(`${boldWrap(leg.legType)} ${leg.depAirport} - ${leg.arrAirport} ${leg.depTime ? `DEP ${leg.depTime}` : ''} ${leg.arrTime ? `ARR ${leg.arrTime}` : ''}`);
                    if (leg.baggageText) {
                        templateParts.push(`${boldWrap('Baggage: ' + leg.baggageText)}`);
                    }
                    if (leg.cancelText) {
                        templateParts.push(`${boldWrap(leg.cancelText)}`);
                    }
                    templateParts.push('');
                });
                const priceLine = `${boldWrap('£' + Math.round(quote.totalSelling).toFixed(0))}${priceSuffix}`;
                templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                templateParts.push('');
            });
        } else if (checkedFlightQuotes.length === 1) {
            const quote = checkedFlightQuotes[0];
            templateParts.push('');
            quote.legs.forEach(leg => {
                templateParts.push(`${boldWrap(leg.legType)} ${leg.depAirport} - ${leg.arrAirport} ${leg.depTime ? `DEP ${leg.depTime}` : ''} ${leg.arrTime ? `ARR ${leg.arrTime}` : ''}`);
                if (leg.baggageText) {
                    templateParts.push(`${boldWrap('Baggage: ' + leg.baggageText)}`);
                }
                if (leg.cancelText) {
                    templateParts.push(`${boldWrap(leg.cancelText)}`);
                }
                templateParts.push('');
            });
            const priceLine = `${boldWrap('£' + Math.round(quote.totalSelling).toFixed(0))}${priceSuffix}`;
            templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
            templateParts.push('');
        }
        if (checkedHotelQuotes.length > 1) {
            checkedHotelQuotes.forEach((quote, index) => {
                templateParts.push(`${boldWrap('HOTEL OPTION ' + (index + 1))}`);
                templateParts.push('');
                if (quote.hotelName) {
                    templateParts.push(`${boldWrap(quote.hotelName.toUpperCase() + ', ' + quote.destination.toUpperCase())}`);
                }
                templateParts.push(`${formatDateRange(quote.startDate, quote.endDate)} - ${quote.nights} Night${quote.nights > 1 ? 's' : ''}`);
                templateParts.push('');
                if (quote.includedSuppliers.length > 0) {
                    if (numRooms > 1) {
                        quote.includedSuppliers.forEach((sup, idx) => {
                            templateParts.push(`${boldWrap(`Room Option ${idx + 1}`)}`);
                            templateParts.push(sup.detailText);
                            const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                            templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                            if (sup.cancelText) {
                                templateParts.push(`${boldWrap(sup.cancelText)}`);
                            }
                            templateParts.push('');
                        });
                    } else {
                        const sup = quote.includedSuppliers[0];
                        templateParts.push(sup.detailText);
                        const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                        templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                        if (sup.cancelText) {
                            templateParts.push(`${boldWrap(sup.cancelText)}`);
                        }
                        templateParts.push('');
                    }
                }
                if (excludesNote) {
                    templateParts.push(`${excludesNote}\n`);
                }
                templateParts.push('');
            });
        } else if (checkedHotelQuotes.length === 1) {
            const quote = checkedHotelQuotes[0];
            if (quote.hotelName) {
                templateParts.push(`${boldWrap(quote.hotelName.toUpperCase() + ', ' + quote.destination.toUpperCase())}`);
            }
            templateParts.push(`${formatDateRange(quote.startDate, quote.endDate)} - ${quote.nights} Night${quote.nights > 1 ? 's' : ''}`);
            templateParts.push('');
            if (quote.includedSuppliers.length > 0) {
                if (numRooms > 1) {
                    quote.includedSuppliers.forEach((sup, idx) => {
                        templateParts.push(`${boldWrap(`Room Option ${idx + 1}`)}`);
                        templateParts.push(sup.detailText);
                        const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                        templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                        if (sup.cancelText) {
                            templateParts.push(`${boldWrap(sup.cancelText)}`);
                        }
                        templateParts.push('');
                    });
                } else {
                    const sup = quote.includedSuppliers[0];
                    templateParts.push(sup.detailText);
                    const priceLine = `${boldWrap('£' + sup.price.toFixed(0))}${priceSuffix}`;
                    templateParts.push(`${boldWrap('Total Cost:')} ${boldWrap(priceLine)}`);
                    if (sup.cancelText) {
                        templateParts.push(`${boldWrap(sup.cancelText)}`);
                    }
                    templateParts.push('');
                }
            }
            if (excludesNote) {
                templateParts.push(`${excludesNote}\n`);
            }
            templateParts.push('');
        }
        if (optionalExtrasText) {
            templateParts.push(`${boldWrap('Optional Extras:')}`);
            templateParts.push(optionalExtrasText);
            templateParts.push('');
        }
        if (isHotelRefundable()) {
            templateParts.push(`${boldWrap('Deposit')} ${boldWrap('£25 pp')}`);
        }
        if (balanceDueDate !== '[balance_due_date]' && balanceDueDate !== '' && balanceDueDate !== 'Pay Now') {
            templateParts.push(`${boldWrap('Balance due by')} ${balanceDueDate}`);
        }
        templateParts.push('');
        templateParts.push(`${boldWrap('Includes 5GB eSim Promo')}`);
        templateParts.push('');
        templateParts.push(`${boldWrap('Our Package Includes')}`);
        templateParts.push('');
        templateParts.push(`${boldWrap('Free 5GB eSim Promo included')}`);
        templateParts.push(`${boldWrap('Flights and airport taxes')}`);
        if (document.getElementById('include-hand-baggage').checked) {
            templateParts.push(`${boldWrap(`${adults} x Small Hand Baggage allowance`)}`);
        }
        if (checkedHotelQuotes.length > 0) {
            const quote = checkedHotelQuotes[0];
            templateParts.push(`${quote.nights} Nights accommodation`);
        }
        templateParts.push(`${boldWrap('Fully ATOL bonded holiday')}`);
        templateParts.push('');
        templateParts.push('Prices are live and subject to change prior to confirmation.');
        templateParts.push('');
        templateParts.push(`Kind regards`);
        templateParts.push(`${agentName}`);
        templateParts.push('');
        templateParts.push('Bradley Travelstore');
        templateParts.push(`T: ${agentPhone}`);
        templateParts.push(`E: ${agentEmail}`);
        templateParts.push(`W: ${websiteUrl}`);
        templateParts.push('');
        templateParts.push('We are fully ATOL bonded for your peace of mind.');
        templateParts.push('');
        templateParts.push(`Your Quote Reference #${quoteReference}`);
    }
    
    const template = templateParts.join('\n');
    
    const output = document.getElementById('email-template');
    if (currentDeliveryOption === 'whatsapp') {
        output.textContent = template;
    } else {
        const htmlTemplate = template.replace(/\n/g, '<br>').replace(/ {2}/g, '&nbsp; ');
        output.innerHTML = htmlTemplate;
    }
    saveState();
}

function copyToClipboard() {
            const output = document.getElementById('email-template');
            let textToCopy;
            if (currentDeliveryOption === 'whatsapp') {
                textToCopy = output.textContent;
            } else {
                textToCopy = output.innerHTML.replace(/<br>/g, '\n').replace(/&nbsp; /g, '  ');
            }
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Email template copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Email template copied to clipboard!');
            });
        }

        function handleEdit() {
            const btn = document.getElementById('edit-btn');
            const template = document.getElementById('email-template');
            if (!isEditing) {
                template.contentEditable = true;
                template.focus();
                isEditing = true;
                btn.textContent = 'Finish Editing';
                btn.classList.remove('btn');
                btn.classList.add('btn-warning');
            } else {
                template.contentEditable = false;
                isEditing = false;
                btn.textContent = 'Edit Email';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn');
            }
        }

        function resetState() {
            if (confirm('This will clear all data. Are you sure?')) {
                localStorage.removeItem('bradleyTravelState');
                usedQuoteNumbers.clear();
                usedFlightQuoteNumbers.clear();
                hotelQuoteSections = [];
                flightQuoteSections = [];
                hotelQuoteCounter = 0;
                flightQuoteCounter = 0;
                roomsData = [];
                location.reload();
            }
        }

        function createTableHeader(type, table) {
            const thead = document.createElement('thead');
            let thHTML = '<tr>';
            if (type === 'hotel') {
                thHTML += `
                    <th>Supplier</th>
                    <th>Net (£)</th>
                    <th>Comm Rate</th>
                    <th>Selling (£)</th>
                    <th>Comm Amt (£)</th>
                    <th>Room Type</th>
                    <th>Rooms</th>
                    <th>Board</th>
                    <th>Cancellation</th>
                    <th>Best</th>
                    <th>Upgrade</th>
                    <th>Include Email</th>
                    <th>Actions</th>
                `;
            }
            thHTML += '</tr>';
            thead.innerHTML = thHTML;
            table.appendChild(thead);
        }

        function collectSupplierData(item, type) {
            const data = {
                roomIndex: parseInt(item.getAttribute('data-room') || '0'),
                supplierName: item.querySelector('.supplier-name').value,
                netPrice: parseFloat(item.querySelector('.net-price').value) || 0,
                commissionRate: item.querySelector('.commission-rate').value,
                sellingPrice: parseFloat(item.querySelector('.selling-price').value) || 0,
                commissionAmount: parseFloat(item.querySelector('.commission-amount').value) || 0,
                upgradeDesc: item.querySelector('.upgrade-desc').value,
                upgradeAmount: parseFloat(item.querySelector('.upgrade-amount').value) || 0,
                best: item.querySelector(`input[id="${item.id}-best"]`) ? item.querySelector(`input[id="${item.id}-best"]`).checked : false,
                upgrade: item.querySelector(`input[id="${item.id}-upgrade"]`) ? item.querySelector(`input[id="${item.id}-upgrade"]`).checked : false,
                includeEmail: item.querySelector(`input[id="${item.id}-include-email"]`) ? item.querySelector(`input[id="${item.id}-include-email"]`).checked : false,
                upgradeAuto: item.querySelector(`input[id="${item.id}-upgrade-auto"]`) ? item.querySelector(`input[id="${item.id}-upgrade-auto"]`).checked : false,
                upgradeManual: item.querySelector(`input[id="${item.id}-upgrade-manual"]`) ? item.querySelector(`input[id="${item.id}-upgrade-manual"]`).checked : false,
                cancellationPolicy: item.querySelector('.cancellation-policy').value,
                cancellationFee: parseFloat(item.querySelector('.cancellation-fee').value) || 0,
                cancellationDeadline: item.querySelector('.cancellation-deadline').value
            };

            if (type === 'hotel') {
                data.roomType = item.querySelector('.room-type').value;
                data.rooms = parseInt(item.querySelector('.rooms').value) || 1;
                data.boardBasis = item.querySelector('.board-basis').value;
                data.destination = document.getElementById(item.closest('.hotel-quote-section').id + '-destination').value;
            }

            return data;
        }

        function collectFlightLegData(item) {
            const id = item.id;
            const data = {
                id: id,
                legType: item.querySelector('.leg-type').value,
                airline: item.querySelector('.airline').value,
                departureAirport: item.querySelector('.departure-airport').value,
                arrivalAirport: item.querySelector('.arrival-airport').value,
                depTime: item.querySelector('.dep-time').value,
                arrTime: item.querySelector('.arr-time').value,
                baggageNumber: parseInt(item.querySelector('.baggage-number').value) || 1,
                baggageAllowance: item.querySelector('.baggage-allowance').value,
                baggagePrice: parseFloat(item.querySelector('.baggage-price').value) || 0,
                includeBaggage: item.querySelector('.baggage-include') ? item.querySelector('.baggage-include').checked : false,
                netPrice: parseFloat(item.querySelector('.net-price').value) || 0,
                commissionRate: item.querySelector('.commission-rate').value,
                sellingPrice: parseFloat(item.querySelector('.selling-price').value) || 0,
                commissionAmount: parseFloat(item.querySelector('.commission-amount').value) || 0,
                cancellationPolicy: item.querySelector('.cancellation-policy').value,
                cancellationFee: parseFloat(item.querySelector('.cancellation-fee').value) || 0,
                cancellationDeadline: item.querySelector('.cancellation-deadline').value,
                upgrade: item.querySelector(`input[id="${id}-upgrade"]`) ? item.querySelector(`input[id="${id}-upgrade"]`).checked : false,
                upgradeAuto: item.querySelector(`input[id="${id}-upgrade-auto"]`) ? item.querySelector(`input[id="${id}-upgrade-auto"]`).checked : false,
                upgradeManual: item.querySelector(`input[id="${id}-upgrade-manual"]`) ? item.querySelector(`input[id="${id}-upgrade-manual"]`).checked : false,
                upgradeDesc: item.querySelector('.upgrade-desc').value,
                upgradeAmount: parseFloat(item.querySelector('.upgrade-amount').value) || 0
            };
            return data;
        }

        // Local Storage Functions
        function saveState() {
            const state = {
                customer: {
                    name: document.getElementById('customer-name').value,
                    roomsData: roomsData
                },
                hotel: {
                    quoteSections: hotelQuoteSections.map(sectionId => {
                        const number = parseInt(sectionId.split('-')[2]);
                        const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                        const include = checkbox ? checkbox.checked : true;
                        const hotelName = document.getElementById(`${sectionId}-hotel-name`).value;
                        const destination = document.getElementById(`${sectionId}-destination`).value;
                        const checkinInput = document.querySelector(`#${sectionId} .hotel-checkin`);
                        const nightsInput = document.querySelector(`#${sectionId} .hotel-nights`);
                        const checkin = checkinInput ? checkinInput.value : '';
                        const nights = nightsInput ? nightsInput.value : '';
                        const excludesCurrency = document.getElementById(`${sectionId}-excludes-currency`).value;
                        const excludesAmount = document.getElementById(`${sectionId}-excludes-amount`).value;
                        const balanceDue = document.getElementById(sectionId).getAttribute('data-balance-due') || '';
                        const suppliers = [];
                        document.querySelectorAll(`#${sectionId} .supplier-table-row`).forEach(item => {
                            suppliers.push(collectSupplierData(item, 'hotel'));
                        });
                        return { number, include, hotelName, destination, checkin, nights, excludesCurrency, excludesAmount, balanceDue, suppliers };
                    })
                },
                flight: {
                    dates: document.getElementById('flight-dates').value,
                    includeHandBaggage: document.getElementById('include-hand-baggage').checked,
                    pricePerRoute: document.getElementById('price-per-route').checked,
                    quoteSections: flightQuoteSections.map(sectionId => {
                        const number = parseInt(sectionId.split('-')[2]);
                        const checkbox = document.querySelector(`#${sectionId} .quote-include`);
                        const include = checkbox ? checkbox.checked : true;
                        const legs = [];
                        document.querySelectorAll(`#${sectionId} .flight-leg-row`).forEach(item => {
                            legs.push(collectFlightLegData(item));
                        });
                        return { number, include, legs };
                    }),
                    optionalExtras: Array.from(document.querySelectorAll('#optional-extras-list .optional-extra-item')).map(item => ({
                        name: item.querySelector('input[type="text"]').value,
                        cost: item.querySelector('input[type="number"]').value,
                        include: item.querySelector('input[type="checkbox"]').checked
                    }))
                },
                commission: document.getElementById('commission-rate').value,
                email: {
                    bookingType: document.getElementById('booking-type').value,
                    quoteRef: document.getElementById('quote-reference').value,
                    agentName: document.getElementById('agent-name').value,
                    customAgentName: document.getElementById('custom-agent-name').value,
                    agentEmail: document.getElementById('agent-email').value,
                    agentPhone: document.getElementById('agent-phone').value,
                    delivery: currentDeliveryOption,
                    pricePerRoom: document.getElementById('price-per-room').checked
                },
                collapsed: {},
                hotelQuoteCounter: hotelQuoteCounter,
                flightQuoteCounter: flightQuoteCounter,
                usedQuoteNumbers: Array.from(usedQuoteNumbers),
                usedFlightQuoteNumbers: Array.from(usedFlightQuoteNumbers)
            };

            // Save collapsed states
            const sections = ['customer', 'hotel', 'flight', 'totals', 'email', 'optional-extras'];
            sections.forEach(secId => {
                const sec = document.getElementById(secId);
                state.collapsed[secId] = sec.classList.contains('collapsed');
            });
            hotelQuoteSections.forEach(secId => {
                const sec = document.getElementById(secId);
                state.collapsed[secId] = sec.classList.contains('collapsed');
            });
            flightQuoteSections.forEach(secId => {
                const sec = document.getElementById(secId);
                state.collapsed[secId] = sec.classList.contains('collapsed');
            });

            localStorage.setItem('bradleyTravelState', JSON.stringify(state));
        }

        function loadState() {
            const stateStr = localStorage.getItem('bradleyTravelState');
            let state = null;
            if (stateStr) {
                try {
                    state = JSON.parse(stateStr);
                } catch (e) {
                    console.error('Invalid saved state:', e);
                }
            }

            if (state) {
                document.getElementById('customer-name').value = state.customer.name || '';

                if (state.customer.roomsData) {
                    roomsData = state.customer.roomsData;
                    document.getElementById('rooms-count').textContent = roomsData.length;
                    updateRoomsContainer();
                    // Restore child ages
                    roomsData.forEach((room, i) => {
                        const inputs = document.querySelectorAll(`#room-${i}-child-ages .child-age-input`);
                        room.childAges.forEach((age, j) => {
                            if (inputs[j]) inputs[j].value = age;
                        });
                    });
                }

                document.getElementById('commission-rate').value = state.commission || '11%';
                updateCommission();

                document.getElementById('booking-type').value = state.email.bookingType || 'hotel';
                document.getElementById('quote-reference').value = state.email.quoteRef || '';
                document.getElementById('agent-name').value = state.email.agentName || 'Adam';
                document.getElementById('custom-agent-name').value = state.email.customAgentName || '';
                document.getElementById('agent-email').value = state.email.agentEmail || '';
                document.getElementById('agent-phone').value = state.email.agentPhone || '';
                document.getElementById('price-per-room').checked = state.email.pricePerRoom || false;
                if (state.flight && state.flight.includeHandBaggage !== undefined) {
                    document.getElementById('include-hand-baggage').checked = state.flight.includeHandBaggage;
                }
                if (state.flight && state.flight.pricePerRoute !== undefined) {
                    document.getElementById('price-per-route').checked = state.flight.pricePerRoute;
                }
                updateAgentSignature();

                currentDeliveryOption = state.email.delivery || 'email';
                document.querySelectorAll('.delivery-option').forEach(el => el.classList.remove('selected'));
                const selectedEl = [...document.querySelectorAll('.delivery-option')].find(el => {
                    const onclick = el.getAttribute('onclick');
                    return onclick && onclick.includes(`'${currentDeliveryOption}'`);
                });
                if (selectedEl) selectedEl.classList.add('selected');

                // Restore used numbers
                if (state.usedQuoteNumbers) {
                    state.usedQuoteNumbers.forEach(num => usedQuoteNumbers.add(num));
                }
                if (state.usedFlightQuoteNumbers) {
                    state.usedFlightQuoteNumbers.forEach(num => usedFlightQuoteNumbers.add(num));
                }

                // Load optional extras
                if (state.flight.optionalExtras) {
                    state.flight.optionalExtras.forEach(extra => {
                        addOptionalExtra();
                        const lastItem = document.querySelector('#optional-extras-list .optional-extra-item:last-child');
                        if (lastItem) {
                            lastItem.querySelector('input[type="text"]').value = extra.name;
                            lastItem.querySelector('input[type="number"]').value = extra.cost;
                            lastItem.querySelector('input[type="checkbox"]').checked = extra.include;
                        }
                    });
                }

                // Set counters
                hotelQuoteCounter = state.hotelQuoteCounter || 0;
                flightQuoteCounter = state.flightQuoteCounter || 0;

                // Load hotel quote sections
                if (state.hotel.quoteSections) {
                    state.hotel.quoteSections.forEach(secData => {
                        addHotelQuoteSection(secData);
                    });
                } else {
                    // Fallback if no sections saved
                    addHotelQuoteSection();
                }

                // Load flight quote sections
                if (state.flight.quoteSections) {
                    state.flight.quoteSections.forEach(secData => {
                        addFlightQuoteSection(secData);
                    });
                } else {
                    // Fallback
                    addFlightQuoteSection();
                }

                if (state.flight.dates) {
                    const dates = state.flight.dates.split(' to ');
                    flightDatesFp.setDate(dates.length === 2 ? [dates[0], dates[1]] : dates[0]);
                }
            }

            // Re-init pickers after loading dynamic content
            hotelQuoteSections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    initCancellationPickers(section);
                    initQuoteDates(id);
                }
            });
            initCancellationPickers(document.getElementById('flight-quotes-container'));

            // Restore collapsed states
            const sections = ['customer', 'hotel', 'flight', 'totals', 'email', 'optional-extras'];
            if (state && state.collapsed) {
                sections.forEach(id => {
                    const sec = document.getElementById(id);
                    if (sec) {
                        sec.classList.remove('collapsed', 'expanded');
                        if (state.collapsed[id]) {
                            sec.classList.add('collapsed');
                        } else {
                            sec.classList.add('expanded');
                        }
                    }
                });
                hotelQuoteSections.forEach(id => {
                    const sec = document.getElementById(id);
                    if (sec) {
                        sec.classList.remove('collapsed', 'expanded');
                        if (state.collapsed[id]) {
                            sec.classList.add('collapsed');
                        } else {
                            sec.classList.add('expanded');
                        }
                    }
                });
                flightQuoteSections.forEach(id => {
                    const sec = document.getElementById(id);
                    if (sec) {
                        sec.classList.remove('collapsed', 'expanded');
                        if (state.collapsed[id]) {
                            sec.classList.add('collapsed');
                        } else {
                            sec.classList.add('expanded');
                        }
                    }
                });
            }

            updateTotals();
            updateEmailTemplate();
        }

        function validateCustomerInfo() {
            const customerName = document.getElementById('customer-name').value.trim();
            
            return customerName !== '';
        }

        function isPolicyComplete(row) {
            const policy = row.querySelector('.cancellation-policy').value;
            if (policy === 'non-refundable') return true;
            if (policy === 'refundable') {
                const deadline = row.querySelector('.cancellation-deadline').value;
                return !!deadline;
            }
            if (policy === 'refundable-with-fee') {
                const deadline = row.querySelector('.cancellation-deadline').value;
                const fee = parseFloat(row.querySelector('.cancellation-fee').value) || 0;
                return !!deadline && fee > 0;
            }
            return false;
        }

        function calculateBalanceDueDateForSection(sectionId) {
            const checkbox = document.querySelector(`#${sectionId} .quote-include`);
            if (!checkbox || !checkbox.checked) {
                return;
            }

            const section = document.getElementById(sectionId);
            const bestRow = Array.from(section.querySelectorAll('.supplier-table-row.best-price')).find(row => row.querySelector('input[id$="-best"]').checked);
            if (!bestRow) {
                return;
            }

            const bestPolicy = bestRow.querySelector('.cancellation-policy').value;
            const deadlineInput = bestRow.querySelector('.cancellation-deadline');
            const deadline = deadlineInput ? deadlineInput.value : '';

            if (!bestPolicy) {
                return;
            }

            let balanceDueDate = '';
            if (bestPolicy === 'non-refundable') {
                balanceDueDate = 'Pay Now';
            } else if (deadline) {
                const deadlineDate = new Date(deadline);
                const balanceDate = new Date(deadlineDate);
                balanceDate.setDate(balanceDate.getDate() - 14);
                balanceDueDate = balanceDate.toISOString().split('T')[0];
            }
            // Store in a data attribute or hidden input if needed for template
            section.setAttribute('data-balance-due', balanceDueDate);
            updateEmailTemplate();
            saveState();
        }

        function calculateAllBalanceDueDates() {
            hotelQuoteSections.forEach(sectionId => {
                calculateBalanceDueDateForSection(sectionId);
            });
        }

        function isHotelRefundable() {
            // Check first checked quote
            const checkedSection = hotelQuoteSections.find(id => {
                const checkbox = document.querySelector(`#${id} .quote-include`);
                return checkbox && checkbox.checked;
            });
            if (!checkedSection) return false;

            const section = document.getElementById(checkedSection);
            const bestRow = Array.from(section.querySelectorAll('.supplier-table-row')).find(row => {
                const cb = row.querySelector('input[id$="-best"]');
                return cb && cb.checked;
            });
            if (!bestRow) return false;

            const bestPolicy = bestRow.querySelector('.cancellation-policy').value;
            return bestPolicy !== 'non-refundable' && bestPolicy !== '';
        }

        function removeSupplier(id) {
            if (confirm('Are you sure you want to remove this supplier option?')) {
                const element = document.getElementById(id);
                if (element) {
                    const section = element.closest('.card');
                    const sectionId = section.id;
                    element.remove();
                    if (sectionId && !section.classList.contains('flight-quote-section')) {
                        updateQuoteTotals(sectionId);
                        calculateBalanceDueDateForSection(sectionId);
                    } else {
                        updateFlightQuoteTotals(sectionId);
                    }
                    updateTotals();
                    updateEmailTemplate();
                    saveState();
                }
            }
        }

        function copyHotelComparison(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const number = sectionId.split('-')[2];
            const hotelName = document.getElementById(`${sectionId}-hotel-name`).value.trim() || '[Hotel Name]';
            const destination = document.getElementById(`${sectionId}-destination`).value.trim() || '[Destination]';
            const checkinInput = section.querySelector('.hotel-checkin');
            const checkin = checkinInput ? checkinInput.value : '';
            const nightsInput = section.querySelector('.hotel-nights');
            const nights = nightsInput ? nightsInput.value : '0';

            let startDate = '', endDate = '';
            if (checkin) {
                const dates = checkin.split(' to ');
                startDate = dates[0] ? formatDate(dates[0]) : '';
                endDate = dates[1] ? formatDate(dates[1]) : '';
            }

            let comparisonText = `HOTEL COMPARISON - Quote ${number}\n\n`;
            comparisonText += `Hotel: ${hotelName}, ${destination}\n`;
            comparisonText += `Dates: ${formatDateRange(startDate, endDate)} - ${nights} Night${nights > 1 ? 's' : ''}\n\n`;

            const numRooms = roomsData.length;
            for (let room = 0; room < numRooms; room++) {
                const compId = `${sectionId}-room-${room}-comparison`;
                const comparison = document.getElementById(compId);
                if (!comparison) continue;

                comparisonText += `Room ${room + 1}:\n`;
                const rows = comparison.querySelectorAll('.supplier-table-row');
                rows.forEach(row => {
                    const supplierName = row.querySelector('.supplier-name').value.trim() || '[Supplier]';
                    const roomType = row.querySelector('.room-type').value || '[Room Type]';
                    const boardBasis = row.querySelector('.board-basis').value || '[Board]';
                    const rooms = parseInt(row.querySelector('.rooms').value) || 1;
                    const sellingPrice = parseFloat(row.querySelector('.selling-price').value) || 0;
                    const cancelPolicy = row.querySelector('.cancellation-policy').value;
                    const cancelText = getCancellationText(cancelPolicy, parseFloat(row.querySelector('.cancellation-fee')?.value || '0'), row.querySelector('.cancellation-deadline')?.value || '');

                    const cleanSupplierName = supplierName.replace(/ Room \d+ \([^)]*\)$/, '').trim();
                    comparisonText += `- ${cleanSupplierName}: ${rooms} x ${roomType} on ${boardBasis}, £${Math.round(sellingPrice * rooms)}, ${cancelText}\n`;

                    // Check if best
                    const bestCb = row.querySelector('input[id$="-best"]');
                    if (bestCb && bestCb.checked) {
                        comparisonText += `  (Best Price)\n`;
                    }
                });
                comparisonText += '\n';
            }

            const netTotal = parseFloat(document.getElementById(`${sectionId}-total-net`).textContent.replace('£', '')) || 0;
            const sellingRounded = parseFloat(document.getElementById(`${sectionId}-total-selling-rounded`).textContent.replace('£', '')) || 0;
            comparisonText += `Total Net: £${netTotal.toFixed(2)}\n`;
            comparisonText += `Total Selling (Rounded): £${sellingRounded.toFixed(2)}\n`;

            navigator.clipboard.writeText(comparisonText).then(() => {
                alert('Hotel comparison copied to clipboard!');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = comparisonText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Hotel comparison copied to clipboard!');
            });
        }

        function copyFlightDetails(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const number = sectionId.split('-')[2];
            let detailsText = `FLIGHT DETAILS - Quote ${number}\n\n`;

            const legs = [];
            section.querySelectorAll('.flight-leg-row').forEach(item => {
                const legType = item.querySelector('.leg-type').value || '[Type]';
                const airline = item.querySelector('.airline').value || '[Airline]';
                const depAirport = item.querySelector('.departure-airport').value.toUpperCase() || '[DEP]';
                const arrAirport = item.querySelector('.arrival-airport').value.toUpperCase() || '[ARR]';
                const depTime = item.querySelector('.dep-time').value.replace(':', '') || '';
                const arrTime = item.querySelector('.arr-time').value.replace(':', '') || '';
                const sellingPrice = parseFloat(item.querySelector('.selling-price').value) || 0;
                const cancelPolicy = item.querySelector('.cancellation-policy').value;
                const cancelText = getCancellationText(cancelPolicy, parseFloat(item.querySelector('.cancellation-fee')?.value || '0'), item.querySelector('.cancellation-deadline')?.value || '');
                const baggageCheckbox = item.querySelector('.baggage-include');
                const includeBaggage = baggageCheckbox ? baggageCheckbox.checked : false;
                let baggageText = '';
                if (includeBaggage) {
                    const baggageNumber = parseInt(item.querySelector('.baggage-number').value) || 1;
                    const baggageAllowance = item.querySelector('.baggage-allowance').value || '';
                    const baggagePrice = parseFloat(item.querySelector('.baggage-price').value) || 0;
                    baggageText = `${baggageNumber} x ${baggageAllowance}${baggagePrice > 0 ? ` (£${Math.round(baggagePrice)})` : ' (included)'}`;
                }

                detailsText += `${legType} ${depAirport} - ${arrAirport} ${depTime ? `DEP ${depTime}` : ''} ${arrTime ? `ARR ${arrTime}` : ''}, ${airline}, £${sellingPrice.toFixed(2)}, ${cancelText}`;
                if (baggageText) {
                    detailsText += `, Baggage: ${baggageText}`;
                }
                detailsText += '\n';

                // Check if upgrade
                const upgradeCb = item.querySelector('input[id$="-upgrade"]');
                if (upgradeCb && upgradeCb.checked) {
                    const upgradeDesc = item.querySelector('.upgrade-desc').value || '';
                    const upgradeAmount = parseFloat(item.querySelector('.upgrade-amount').value) || 0;
                    detailsText += `  (Upgrade: ${upgradeDesc || 'Custom'} +£${upgradeAmount.toFixed(2)})\n`;
                } else {
                    detailsText += '\n';
                }

                legs.push({ sellingPrice });
            });

            const totalSelling = legs.reduce((sum, leg) => sum + leg.sellingPrice, 0);
            const sellingRounded = parseFloat(document.getElementById(`${sectionId}-total-selling-rounded`).textContent.replace('£', '')) || 0;
            detailsText += `\nTotal Selling (Exact): £${totalSelling.toFixed(2)}\n`;
            detailsText += `Total Selling (Rounded): £${sellingRounded.toFixed(2)}\n`;

            navigator.clipboard.writeText(detailsText).then(() => {
                alert('Flight details copied to clipboard!');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = detailsText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Flight details copied to clipboard!');
            });
        }
    </script>
</body>
</html>
